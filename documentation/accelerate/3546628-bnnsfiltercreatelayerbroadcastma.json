{
  "abstract": [
    {
      "type": "text",
      "text": "Returns a new broadcast matrix multiply layer."
    }
  ],
  "documentVersion": 0,
  "hierarchy": {
    "paths": [
      [
        "doc://com.apple.documentation/documentation/technologies",
        "doc://com.apple.documentation/documentation/accelerate",
        "doc://com.apple.documentation/documentation/accelerate/bnns"
      ]
    ]
  },
  "identifier": {
    "url": "doc://com.apple.documentation/documentation/accelerate/3546628-bnnsfiltercreatelayerbroadcastma",
    "interfaceLanguage": "occ"
  },
  "legacy_identifier": 3546628,
  "kind": "symbol",
  "metadata": {
    "title": "BNNSFilterCreateLayerBroadcastMatMul",
    "role": "symbol",
    "roleHeading": "Function",
    "modules": [
      {
        "name": "Accelerate"
      }
    ],
    "platforms": [
      {
        "name": "iOS",
        "introducedAt": "14.0",
        "current": "14.3"
      },
      {
        "name": "macOS",
        "introducedAt": "11.0",
        "current": "11.1"
      },
      {
        "name": "Mac Catalyst",
        "introducedAt": "14.0",
        "current": "14.3"
      },
      {
        "name": "tvOS",
        "introducedAt": "14.0",
        "current": "14.3"
      },
      {
        "name": "watchOS",
        "introducedAt": "7.0",
        "current": "7.2"
      }
    ],
    "externalID": "c:@F@BNNSFilterCreateLayerBroadcastMatMul",
    "symbolKind": "func"
  },
  "schemaVersion": {
    "major": 1,
    "minor": 0,
    "patch": 0
  },
  "sections": [],
  "variants": [
    {
      "traits": [
        {
          "interfaceLanguage": "occ"
        }
      ],
      "paths": [
        "documentation/accelerate/3546628-bnnsfiltercreatelayerbroadcastma"
      ]
    },
    {
      "traits": [
        {
          "interfaceLanguage": "swift"
        }
      ],
      "paths": [
        "documentation/accelerate/3546628-bnnsfiltercreatelayerbroadcastma"
      ]
    }
  ],
  "references": {
    "doc://com.apple.documentation/documentation/accelerate": {
      "title": "Accelerate",
      "identifier": "doc://com.apple.documentation/documentation/accelerate",
      "url": "/documentation/accelerate",
      "type": "topic",
      "kind": "symbol",
      "role": "collection"
    },
    "doc://com.apple.documentation/documentation/accelerate/bnns": {
      "title": "BNNS",
      "identifier": "doc://com.apple.documentation/documentation/accelerate/bnns",
      "url": "/documentation/accelerate/bnns",
      "type": "topic",
      "kind": "article",
      "role": "collectionGroup"
    },
    "doc://com.apple.documentation/documentation/accelerate/3546628-bnnsfiltercreatelayerbroadcastma#3597342": {
      "title": "Listing 1",
      "type": "section",
      "identifier": "doc://com.apple.documentation/documentation/accelerate/3546628-bnnsfiltercreatelayerbroadcastma#3597342",
      "kind": "article",
      "role": "codeListing",
      "url": "/documentation/accelerate/3546628-bnnsfiltercreatelayerbroadcastma#3597342"
    },
    "doc://com.apple.documentation/documentation/accelerate/3546628-bnnsfiltercreatelayerbroadcastma#3597341": {
      "title": "Listing 2",
      "type": "section",
      "identifier": "doc://com.apple.documentation/documentation/accelerate/3546628-bnnsfiltercreatelayerbroadcastma#3597341",
      "kind": "article",
      "role": "codeListing",
      "url": "/documentation/accelerate/3546628-bnnsfiltercreatelayerbroadcastma#3597341"
    },
    "doc://com.apple.documentation/documentation/accelerate/bnnslayerparametersbroadcastmatmul/3546842-b_is_weights": {
      "title": "b_is_weights",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/accelerate/bnnslayerparametersbroadcastmatmul/3546842-b_is_weights",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/accelerate/bnnslayerparametersbroadcastmatmul/3546842-b_is_weights"
    },
    "doc://com.apple.documentation/documentation/accelerate/3546628-bnnsfiltercreatelayerbroadcastma#3597340": {
      "title": "Listing 3",
      "type": "section",
      "identifier": "doc://com.apple.documentation/documentation/accelerate/3546628-bnnsfiltercreatelayerbroadcastma#3597340",
      "kind": "article",
      "role": "codeListing",
      "url": "/documentation/accelerate/3546628-bnnsfiltercreatelayerbroadcastma#3597340"
    },
    "doc://com.apple.documentation/documentation/accelerate/3546628-bnnsfiltercreatelayerbroadcastma#3597343": {
      "title": "Listing 4",
      "type": "section",
      "identifier": "doc://com.apple.documentation/documentation/accelerate/3546628-bnnsfiltercreatelayerbroadcastma#3597343",
      "kind": "article",
      "role": "codeListing",
      "url": "/documentation/accelerate/3546628-bnnsfiltercreatelayerbroadcastma#3597343"
    },
    "doc://com.apple.documentation/documentation/accelerate/bnnslayerparametersbroadcastmatmul": {
      "title": "BNNSLayerParametersBroadcastMatMul",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/accelerate/bnnslayerparametersbroadcastmatmul",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/accelerate/bnnslayerparametersbroadcastmatmul",
      "abstract": [
        {
          "type": "text",
          "text": "A structure that contains the parameters of a broadcast matrix multiply layer."
        }
      ]
    },
    "doc://com.apple.documentation/documentation/accelerate/bnnsfilterparameters": {
      "title": "BNNSFilterParameters",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/accelerate/bnnsfilterparameters",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/accelerate/bnnsfilterparameters"
    },
    "doc://com.apple.documentation/documentation/accelerate/3546628-bnnsfiltercreatelayerbroadcastma": {
      "title": "BNNSFilterCreateLayerBroadcastMatMul",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/accelerate/3546628-bnnsfiltercreatelayerbroadcastma",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/accelerate/3546628-bnnsfiltercreatelayerbroadcastma",
      "abstract": [
        {
          "type": "text",
          "text": "Returns a new broadcast matrix multiply layer."
        }
      ]
    },
    "doc://com.apple.documentation/documentation/accelerate/3546617-bnnsdirectapplybroadcastmatmul": {
      "title": "BNNSDirectApplyBroadcastMatMul",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/accelerate/3546617-bnnsdirectapplybroadcastmatmul",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/accelerate/3546617-bnnsdirectapplybroadcastmatmul",
      "abstract": [
        {
          "type": "text",
          "text": "Applies a broadcast matrix multiplication operation directly to two input matrices."
        }
      ]
    },
    "doc://com.apple.documentation/documentation/technologies": {
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/technologies",
      "url": "/documentation/technologies",
      "kind": "technologies",
      "title": "Technologies"
    }
  },
  "seeAlsoSections": [
    {
      "identifiers": [
        "doc://com.apple.documentation/documentation/accelerate/bnnslayerparametersbroadcastmatmul",
        "doc://com.apple.documentation/documentation/accelerate/3546617-bnnsdirectapplybroadcastmatmul"
      ],
      "title": "Broadcast Matrix Multiplication Layers",
      "generated": true
    }
  ],
  "primaryContentSections": [
    {
      "kind": "declarations",
      "declarations": [
        {
          "languages": [
            "occ"
          ],
          "tokens": [
            {
              "kind": "keyword",
              "text": "void"
            },
            {
              "kind": "text",
              "text": " * "
            },
            {
              "kind": "identifier",
              "text": "BNNSFilterCreateLayerBroadcastMatMul"
            },
            {
              "kind": "text",
              "text": "("
            },
            {
              "kind": "keyword",
              "text": "const"
            },
            {
              "kind": "text",
              "text": " "
            },
            {
              "kind": "typeIdentifier",
              "preciseIdentifier": "c:@T@BNNSLayerParametersBroadcastMatMul",
              "identifier": "doc://com.apple.documentation/documentation/accelerate/bnnslayerparametersbroadcastmatmul",
              "text": "BNNSLayerParametersBroadcastMatMul"
            },
            {
              "kind": "text",
              "text": " *layer_params, "
            },
            {
              "kind": "keyword",
              "text": "const"
            },
            {
              "kind": "text",
              "text": " "
            },
            {
              "kind": "typeIdentifier",
              "preciseIdentifier": "c:@T@BNNSFilterParameters",
              "identifier": "doc://com.apple.documentation/documentation/accelerate/bnnsfilterparameters",
              "text": "BNNSFilterParameters"
            },
            {
              "kind": "text",
              "text": " *filter_params);"
            }
          ],
          "platforms": [
            "iOS",
            "macOS",
            "Mac Catalyst",
            "tvOS",
            "watchOS"
          ]
        }
      ]
    },
    {
      "kind": "parameters",
      "languages": [
        "occ"
      ],
      "parameters": [
        {
          "name": "layer_params  ",
          "content": [
            {
              "type": "paragraph",
              "inlineContent": [
                {
                  "type": "text",
                  "text": "Layer parameters."
                }
              ]
            }
          ]
        },
        {
          "name": "filter_params  ",
          "content": [
            {
              "type": "paragraph",
              "inlineContent": [
                {
                  "type": "text",
                  "text": "The filter runtime parameters."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "kind": "content",
      "content": [
        {
          "anchor": "discussion",
          "level": 2,
          "text": "Discussion",
          "type": "heading"
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "Use broadcast matrix to perform matrix multiplication on the last two indices of two tensors. "
            }
          ]
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "In a case where one tensor has a higher rank (that is, the number of dimensions) than the other, the lower rank matrix is broadcast in the missing dimensions. The operation broadcasts dimensions with a size of one to match the size of the corresponding dimension in the other tensor. For example, given the following data that describes two 3D matrices of two columns, four rows, and three channels:"
            }
          ]
        },
        {
          "type": "codeListing",
          "code": [
            "let inputValues: [Float] = [",
            "    // Batch 0, channel 0.",
            "    11, 21,",
            "    31, 41,",
            "    51, 61,",
            "    71, 81,",
            "",
            "    // Batch 0, channel 1.",
            "    101, 201,",
            "    301, 401,",
            "    501, 601,",
            "    701, 801,",
            "",
            "    // Batch 0, channel 2.",
            "    1001, 2001,",
            "    3001, 4001,",
            "    5001, 6001,",
            "    7001, 8001,",
            "",
            "    // Batch 1, channel 0.",
            "    12, 22,",
            "    32, 42,",
            "    52, 62,",
            "    72, 82,",
            "    ",
            "    // Batch 1, channel 1.",
            "    102, 202,",
            "    302, 402,",
            "    502, 602,",
            "    702, 802,",
            "",
            "    // Batch 1, channel 2.",
            "    1002, 2002,",
            "    3002, 4002,",
            "    5002, 6002,",
            "    7002, 8002",
            "]"
          ],
          "syntax": "swift",
          "metadata": {
            "anchor": "3597342",
            "title": "Listing 1"
          }
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "Broadcast matrix multiplication provides the functionality to multiply the 3D data in "
            },
            {
              "type": "codeVoice",
              "code": "inputValues"
            },
            {
              "type": "text",
              "text": " by a 2D matrix by braodcasting it across the missing dimension. In this example, the second matrix contains the following values:"
            }
          ]
        },
        {
          "type": "codeListing",
          "code": [
            "var weightsValues: [Float] = [",
            "    2, 0,",
            "    0, 2",
            "]"
          ],
          "syntax": "swift",
          "metadata": {
            "anchor": "3597341",
            "title": "Listing 2"
          }
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "The following code creates "
            },
            {
              "type": "codeVoice",
              "code": "BNNSNDArrayDescriptor"
            },
            {
              "type": "text",
              "text": " structures to describe the two inputs and the output. Note that the code passes the second input, "
            },
            {
              "type": "codeVoice",
              "code": "weights"
            },
            {
              "type": "text",
              "text": ", to the parameters structure with "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/accelerate/bnnslayerparametersbroadcastmatmul/3546842-b_is_weights"
            },
            {
              "type": "text",
              "text": " set to "
            },
            {
              "type": "codeVoice",
              "code": "true"
            },
            {
              "type": "text",
              "text": ". This means that the filter stores the data pointer to "
            },
            {
              "type": "codeVoice",
              "code": "weights"
            },
            {
              "type": "text",
              "text": ", and you don’t need to pass the weights data to the apply call."
            }
          ]
        },
        {
          "type": "codeListing",
          "code": [
            "let batchSize = 2",
            "",
            "let i_desc = BNNSNDArrayDescriptor(flags: BNNSNDArrayFlags(0),",
            "                                   layout: BNNSDataLayoutImageCHW,",
            "                                   size: (3, 4, 2, 0, 0, 0, 0, 0),",
            "                                   stride: (0, 0, 0, 0, 0, 0, 0, 0),",
            "                                   data: nil,",
            "                                   data_type: .float,",
            "                                   table_data: nil,",
            "                                   table_data_type: .float,",
            "                                   data_scale: 1,",
            "                                   data_bias: 0)",
            "",
            "weightsValues.withUnsafeMutableBufferPointer { weightsPtr in",
            "    let w_desc = BNNSNDArrayDescriptor(flags: BNNSNDArrayFlags(0),",
            "                                       layout: BNNSDataLayoutRowMajorMatrix,",
            "                                       size: (2, 2, 0, 0, 0, 0, 0, 0),",
            "                                       stride: (0, 0, 0, 0, 0, 0, 0, 0),",
            "                                       data: weightsPtr.baseAddress,",
            "                                       data_type: .float,",
            "                                       table_data: nil,",
            "                                       table_data_type: .float,",
            "                                       data_scale: 1,",
            "                                       data_bias: 0)",
            "",
            "    let o_desc = BNNSNDArrayDescriptor(flags: BNNSNDArrayFlags(0),",
            "                                       layout: BNNSDataLayoutImageCHW,",
            "                                       size: (i_desc.size.0, i_desc.size.1, w_desc.size.1, 0, 0, 0, 0, 0),",
            "                                       stride: (0, 0, 0, 0, 0, 0, 0, 0),",
            "                                       data: nil,",
            "                                       data_type: .float,",
            "                                       table_data: nil,",
            "                                       table_data_type: .float,",
            "                                       data_scale: 1,",
            "                                       data_bias: 0)",
            "    ",
            "    var layer_params = BNNSLayerParametersBroadcastMatMul(alpha: 1,",
            "                                                          beta: 0,",
            "                                                          transA: false,",
            "                                                          transB: false,",
            "                                                          quadratic: false,",
            "                                                          a_is_weights: false,",
            "                                                          b_is_weights: true,",
            "                                                          iA_desc: i_desc,",
            "                                                          iB_desc: w_desc,",
            "                                                          o_desc: o_desc)",
            "    ",
            "    let filter = BNNSFilterCreateLayerBroadcastMatMul(&layer_params, nil)",
            "    defer {",
            "        BNNSFilterDestroy(filter)",
            "    }",
            "    ",
            "    var outputValues = [Float](repeating: -1,",
            "                                 count: o_desc.size.0 * o_desc.size.1 * o_desc.size.2 * batchSize)",
            "    ",
            "    BNNSFilterApplyBatch(filter, batchSize,",
            "                         inputValues, i_desc.size.0 * i_desc.size.1 * i_desc.size.2,",
            "                         &outputValues, o_desc.size.0 * o_desc.size.1 * o_desc.size.2)",
            "}"
          ],
          "syntax": "swift",
          "metadata": {
            "anchor": "3597340",
            "title": "Listing 3"
          }
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "On return, "
            },
            {
              "type": "codeVoice",
              "code": "outputValues"
            },
            {
              "type": "text",
              "text": " contains each element of the input values, multiplied by 2:"
            }
          ]
        },
        {
          "type": "codeListing",
          "code": [
            "[ // Batch 0, channel 0.",
            "  22.0, 42.0, ",
            "  62.0, 82.0, ",
            "  102.0, 122.0, ",
            "  142.0, 162.0, ",
            "",
            "  // Batch 0, channel 1.",
            "  202.0, 402.0, ",
            "  602.0, 802.0, ",
            "  1002.0, 1202.0, ",
            "  1402.0, 1602.0, ",
            "",
            "  // Batch 0, channel 2.",
            "  2002.0, 4002.0, ",
            "  6002.0, 8002.0, ",
            "  10002.0, 12002.0, ",
            "  14002.0, 16002.0, ",
            "",
            "  // Batch 1, channel 0.",
            "  24.0, 44.0, ",
            "  64.0, 84.0, ",
            "  104.0, 124.0, ",
            "  144.0, 164.0, ",
            "",
            "  // Batch 1, channel 1.",
            "  204.0, 404.0, ",
            "  604.0, 804.0, ",
            "  1004.0, 1204.0, ",
            "  1404.0, 1604.0, ",
            "",
            "  // Batch 1, channel 2.",
            "  2004.0, 4004.0, ",
            "  6004.0, 8004.0, ",
            "  10004.0, 12004.0, ",
            "  14004.0, 16004.0 ]"
          ],
          "syntax": "swift",
          "metadata": {
            "anchor": "3597343",
            "title": "Listing 4"
          }
        },
        {
          "type": "paragraph",
          "inlineContent": []
        },
        {
          "type": "paragraph",
          "inlineContent": []
        },
        {
          "type": "paragraph",
          "inlineContent": []
        },
        {
          "type": "paragraph",
          "inlineContent": []
        },
        {
          "type": "paragraph",
          "inlineContent": []
        }
      ]
    }
  ],
  "legalNotices": {
    "copyright": "Copyright &copy; 2020 Apple Inc. All rights reserved.",
    "termsOfUse": "https://www.apple.com/legal/internet-services/terms/site.html",
    "privacyPolicy": "https://www.apple.com/privacy/privacy-policy"
  }
}