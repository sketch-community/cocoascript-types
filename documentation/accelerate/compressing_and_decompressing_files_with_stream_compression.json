{
  "abstract": [
    {
      "type": "text",
      "text": "Perform compression or the appropriate kind of decompression to a file based on its path extension."
    }
  ],
  "documentVersion": 0,
  "hierarchy": {
    "paths": [
      [
        "doc://com.apple.documentation/documentation/technologies",
        "doc://com.apple.documentation/documentation/compression"
      ],
      [
        "doc://com.apple.documentation/documentation/technologies",
        "doc://com.apple.documentation/documentation/accelerate"
      ]
    ]
  },
  "identifier": {
    "url": "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression",
    "interfaceLanguage": "occ"
  },
  "legacy_identifier": 3034219,
  "kind": "article",
  "metadata": {
    "title": "Compressing and Decompressing Files with Stream Compression",
    "role": "sampleCode",
    "roleHeading": "Sample Code",
    "modules": [
      {
        "name": "Compression"
      }
    ],
    "platforms": [
      {
        "name": "macOS",
        "introducedAt": "10.14",
        "current": "11.1"
      },
      {
        "name": "Xcode",
        "introducedAt": "11.0",
        "current": "12.3"
      }
    ]
  },
  "schemaVersion": {
    "major": 1,
    "minor": 0,
    "patch": 0
  },
  "sections": [],
  "variants": [
    {
      "traits": [
        {
          "interfaceLanguage": "occ"
        }
      ],
      "paths": [
        "documentation/accelerate/compressing_and_decompressing_files_with_stream_compression",
        "documentation/compression/compressing_and_decompressing_files_with_stream_compression"
      ]
    },
    {
      "traits": [
        {
          "interfaceLanguage": "swift"
        }
      ],
      "paths": [
        "documentation/accelerate/compressing_and_decompressing_files_with_stream_compression",
        "documentation/compression/compressing_and_decompressing_files_with_stream_compression"
      ]
    }
  ],
  "references": {
    "doc://com.apple.documentation/documentation/compression": {
      "title": "Compression",
      "identifier": "doc://com.apple.documentation/documentation/compression",
      "url": "/documentation/compression",
      "type": "topic",
      "kind": "symbol",
      "role": "collection"
    },
    "doc://com.apple.documentation/documentation/accelerate": {
      "title": "Accelerate",
      "identifier": "doc://com.apple.documentation/documentation/accelerate",
      "url": "/documentation/accelerate",
      "type": "topic",
      "kind": "symbol",
      "role": "collection"
    },
    "doc://com.apple.documentation/documentation/appkit/nsview/1483578-registerfordraggedtypes": {
      "title": "registerForDraggedTypes:",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/appkit/nsview/1483578-registerfordraggedtypes",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/appkit/nsview/1483578-registerfordraggedtypes",
      "fragments": [
        {
          "kind": "text",
          "text": "- "
        },
        {
          "kind": "identifier",
          "text": "registerForDraggedTypes:"
        }
      ]
    },
    "doc://com.apple.documentation/documentation/appkit/nsview/1483568-viewdidmovetosuperview": {
      "title": "viewDidMoveToSuperview",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/appkit/nsview/1483568-viewdidmovetosuperview",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/appkit/nsview/1483568-viewdidmovetosuperview",
      "fragments": [
        {
          "kind": "text",
          "text": "- "
        },
        {
          "kind": "identifier",
          "text": "viewDidMoveToSuperview"
        }
      ]
    },
    "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616384": {
      "title": "Listing 1",
      "type": "section",
      "identifier": "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616384",
      "kind": "article",
      "role": "codeListing",
      "url": "/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616384"
    },
    "doc://com.apple.documentation/documentation/appkit/nsdraggingdestination/1415970-performdragoperation": {
      "title": "performDragOperation:",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/appkit/nsdraggingdestination/1415970-performdragoperation",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/appkit/nsdraggingdestination/1415970-performdragoperation",
      "fragments": [
        {
          "kind": "text",
          "text": "- "
        },
        {
          "kind": "identifier",
          "text": "performDragOperation:"
        }
      ]
    },
    "doc://com.apple.documentation/documentation/foundation/url": {
      "title": "URL",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/foundation/url",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/foundation/url"
    },
    "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616385": {
      "title": "Listing 2",
      "type": "section",
      "identifier": "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616385",
      "kind": "article",
      "role": "codeListing",
      "url": "/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616385"
    },
    "doc://com.apple.documentation/documentation/compression/compression_algorithm/compression_lzfse": {
      "title": "COMPRESSION_LZFSE",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/compression/compression_algorithm/compression_lzfse",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/compression/compression_algorithm/compression_lzfse"
    },
    "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616387": {
      "title": "Listing 3",
      "type": "section",
      "identifier": "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616387",
      "kind": "article",
      "role": "codeListing",
      "url": "/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616387"
    },
    "doc://com.apple.documentation/documentation/compression/compression_algorithm/compression_zlib": {
      "title": "COMPRESSION_ZLIB",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/compression/compression_algorithm/compression_zlib",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/compression/compression_algorithm/compression_zlib"
    },
    "doc://com.apple.documentation/documentation/compression/compression_algorithm": {
      "title": "compression_algorithm",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/compression/compression_algorithm",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/compression/compression_algorithm"
    },
    "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616389": {
      "title": "Listing 4",
      "type": "section",
      "identifier": "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616389",
      "kind": "article",
      "role": "codeListing",
      "url": "/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616389"
    },
    "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616390": {
      "title": "Listing 5",
      "type": "section",
      "identifier": "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616390",
      "kind": "article",
      "role": "codeListing",
      "url": "/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616390"
    },
    "doc://com.apple.documentation/documentation/foundation/nsfilehandle": {
      "title": "NSFileHandle",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/foundation/nsfilehandle",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/foundation/nsfilehandle"
    },
    "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616392": {
      "title": "Listing 6",
      "type": "section",
      "identifier": "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616392",
      "kind": "article",
      "role": "codeListing",
      "url": "/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616392"
    },
    "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616393": {
      "title": "Listing 7",
      "type": "section",
      "identifier": "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616393",
      "kind": "article",
      "role": "codeListing",
      "url": "/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616393"
    },
    "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616395": {
      "title": "Listing 8",
      "type": "section",
      "identifier": "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616395",
      "kind": "article",
      "role": "codeListing",
      "url": "/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616395"
    },
    "doc://com.apple.documentation/documentation/compression/compression_stream": {
      "title": "compression_stream",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/compression/compression_stream",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/compression/compression_stream",
      "abstract": [
        {
          "type": "text",
          "text": "A structure representing a compression stream."
        }
      ]
    },
    "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616397": {
      "title": "Listing 9",
      "type": "section",
      "identifier": "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616397",
      "kind": "article",
      "role": "codeListing",
      "url": "/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616397"
    },
    "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616398": {
      "title": "Listing 10",
      "type": "section",
      "identifier": "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616398",
      "kind": "article",
      "role": "codeListing",
      "url": "/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616398"
    },
    "doc://com.apple.documentation/documentation/compression/1480978-compression_stream_destroy": {
      "title": "compression_stream_destroy",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/compression/1480978-compression_stream_destroy",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/compression/1480978-compression_stream_destroy",
      "abstract": [
        {
          "type": "text",
          "text": "Frees any memory allocated by stream initialization function."
        }
      ]
    },
    "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616399": {
      "title": "Listing 11",
      "type": "section",
      "identifier": "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616399",
      "kind": "article",
      "role": "codeListing",
      "url": "/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616399"
    },
    "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616400": {
      "title": "Listing 12",
      "type": "section",
      "identifier": "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616400",
      "kind": "article",
      "role": "codeListing",
      "url": "/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616400"
    },
    "doc://com.apple.documentation/documentation/compression/compression_stream_flags/compression_stream_finalize": {
      "title": "COMPRESSION_STREAM_FINALIZE",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/compression/compression_stream_flags/compression_stream_finalize",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/compression/compression_stream_flags/compression_stream_finalize"
    },
    "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616402": {
      "title": "Listing 13",
      "type": "section",
      "identifier": "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616402",
      "kind": "article",
      "role": "codeListing",
      "url": "/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616402"
    },
    "doc://com.apple.documentation/documentation/compression/1480976-compression_stream_process": {
      "title": "compression_stream_process",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/compression/1480976-compression_stream_process",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/compression/1480976-compression_stream_process",
      "abstract": [
        {
          "type": "text",
          "text": "Performs compression or decompression using an initialized compression stream structure."
        }
      ]
    },
    "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616404": {
      "title": "Listing 14",
      "type": "section",
      "identifier": "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616404",
      "kind": "article",
      "role": "codeListing",
      "url": "/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616404"
    },
    "doc://com.apple.documentation/documentation/compression/compression_status/compression_status_ok": {
      "title": "COMPRESSION_STATUS_OK",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/compression/compression_status/compression_status_ok",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/compression/compression_status/compression_status_ok"
    },
    "doc://com.apple.documentation/documentation/compression/compression_status/compression_status_end": {
      "title": "COMPRESSION_STATUS_END",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/compression/compression_status/compression_status_end",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/compression/compression_status/compression_status_end"
    },
    "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616406": {
      "title": "Listing 15",
      "type": "section",
      "identifier": "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616406",
      "kind": "article",
      "role": "codeListing",
      "url": "/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616406"
    },
    "doc://com.apple.documentation/documentation/foundation/nsfilehandle/1413393-closefile": {
      "title": "closeFile",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/foundation/nsfilehandle/1413393-closefile",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/foundation/nsfilehandle/1413393-closefile",
      "fragments": [
        {
          "kind": "text",
          "text": "- "
        },
        {
          "kind": "identifier",
          "text": "closeFile"
        }
      ]
    },
    "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616408": {
      "title": "Listing 16",
      "type": "section",
      "identifier": "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616408",
      "kind": "article",
      "role": "codeListing",
      "url": "/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616408"
    },
    "doc://com.apple.documentation/documentation/foundation/1409211-nstemporarydirectory": {
      "title": "NSTemporaryDirectory",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/foundation/1409211-nstemporarydirectory",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/foundation/1409211-nstemporarydirectory"
    },
    "link-media-3616382": {
      "identifier": "link-media-3616382",
      "type": "link",
      "title": "Figure 1",
      "url": "/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression#3616382"
    },
    "media-3616382": {
      "identifier": "media-3616382",
      "type": "image",
      "variants": [
        {
          "traits": [
            "2x"
          ],
          "size": {
            "width": 489,
            "height": 432
          },
          "url": "https://docs-assets.developer.apple.com/published/580c8a7600/78d67805-b1a1-4bfa-94dc-e93d653cb4c1.png"
        }
      ],
      "alt": "Graphic illustrating the stream compression and decompression workflow ",
      "title": "Figure 1"
    },
    "doc://com.apple.documentation/documentation/appkit/nsprogressindicator": {
      "title": "NSProgressIndicator",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/appkit/nsprogressindicator",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/appkit/nsprogressindicator"
    },
    "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression": {
      "title": "Compressing and Decompressing Files with Stream Compression",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression",
      "kind": "article",
      "role": "sampleCode",
      "url": "/documentation/accelerate/compressing_and_decompressing_files_with_stream_compression",
      "abstract": [
        {
          "type": "text",
          "text": "Perform compression or the appropriate kind of decompression to a file based on its path extension."
        }
      ]
    },
    "doc://com.apple.documentation/documentation/compression/1480964-compression_stream_init": {
      "title": "compression_stream_init",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/compression/1480964-compression_stream_init",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/compression/1480964-compression_stream_init",
      "abstract": [
        {
          "type": "text",
          "text": "Initializes a compression stream for either compression or decompression."
        }
      ]
    },
    "doc://com.apple.documentation/documentation/compression/compression_status": {
      "title": "compression_status",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/compression/compression_status",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/compression/compression_status",
      "abstract": [
        {
          "type": "text",
          "text": "A set of values used to represent the status of stream compression."
        }
      ]
    },
    "doc://com.apple.documentation/documentation/compression/compression_stream_flags": {
      "title": "compression_stream_flags",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/compression/compression_stream_flags",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/compression/compression_stream_flags",
      "abstract": [
        {
          "type": "text",
          "text": "A set of values used to represent stream compression flags."
        }
      ]
    },
    "doc://com.apple.documentation/documentation/compression/compression_stream_operation": {
      "title": "compression_stream_operation",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/compression/compression_stream_operation",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/compression/compression_stream_operation",
      "abstract": [
        {
          "type": "text",
          "text": "A set of values used to represent a stream compression operation."
        }
      ]
    },
    "https://docs-assets.developer.apple.com/published/ceea83413b/CompressingAndDecompressingFilesWithStreamCompression.zip": {
      "type": "download",
      "identifier": "https://docs-assets.developer.apple.com/published/ceea83413b/CompressingAndDecompressingFilesWithStreamCompression.zip",
      "checksum": "f60f7151619aad0fdea4ffa9c32bdcc75c33b5ed05db2eac39865ceccc81991846249ebd2293fd55d85921c66ff0eeba9c5a950e0623d872c4f27c07763c48be",
      "url": "https://docs-assets.developer.apple.com/published/ceea83413b/CompressingAndDecompressingFilesWithStreamCompression.zip"
    },
    "doc://com.apple.documentation/documentation/technologies": {
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/technologies",
      "url": "/documentation/technologies",
      "kind": "technologies",
      "title": "Technologies"
    }
  },
  "sampleCodeDownload": {
    "action": {
      "overridingTitle": "Download",
      "type": "reference",
      "isActive": true,
      "identifier": "https://docs-assets.developer.apple.com/published/ceea83413b/CompressingAndDecompressingFilesWithStreamCompression.zip"
    }
  },
  "seeAlsoSections": [
    {
      "identifiers": [
        "doc://com.apple.documentation/documentation/compression/compression_stream",
        "doc://com.apple.documentation/documentation/compression/1480964-compression_stream_init",
        "doc://com.apple.documentation/documentation/compression/1480976-compression_stream_process",
        "doc://com.apple.documentation/documentation/compression/1480978-compression_stream_destroy",
        "doc://com.apple.documentation/documentation/compression/compression_status",
        "doc://com.apple.documentation/documentation/compression/compression_stream_flags",
        "doc://com.apple.documentation/documentation/compression/compression_stream_operation"
      ],
      "title": "Multiple-Step Compression",
      "generated": true
    }
  ],
  "primaryContentSections": [
    {
      "kind": "content",
      "content": [
        {
          "anchor": "overview",
          "level": 2,
          "text": "Overview",
          "type": "heading"
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "This sample code project uses the Compression framework to encode (compress) and decode (decompress) files by dragging them to the app window. The app decompresses files with an extension that matches a supported compression algorithm (that is, "
            },
            {
              "type": "codeVoice",
              "code": ".lz4"
            },
            {
              "type": "text",
              "text": ", "
            },
            {
              "type": "codeVoice",
              "code": ".zlib"
            },
            {
              "type": "text",
              "text": ", "
            },
            {
              "type": "codeVoice",
              "code": ".lzma"
            },
            {
              "type": "text",
              "text": ", or "
            },
            {
              "type": "codeVoice",
              "code": ".lzfse"
            },
            {
              "type": "text",
              "text": "), and compresses all other files. The app writes the encoded or decoded result to the temporary directory returned by the "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/foundation/1409211-nstemporarydirectory"
            },
            {
              "type": "text",
              "text": " function."
            }
          ]
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "This sample implements "
            },
            {
              "type": "emphasis",
              "inlineContent": [
                {
                  "type": "text",
                  "text": "stream compression"
                }
              ]
            },
            {
              "type": "text",
              "text": ", where the app calls the encode or decode functions repeatedly to compress or decompress data from a source buffer to a destination buffer. Between calls, the app removes processed data from the source buffer and loads the new data into the destination buffer:"
            }
          ]
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "image",
              "identifier": "media-3616382",
              "metadata": {
                "anchor": "3616382",
                "title": "Figure 1"
              }
            }
          ]
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "The advantage of this approach is that by moving the encoding or decoding to a background thread, you’re able to keep your app interactive and update the user with progress of the operation (for example, with an "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/appkit/nsprogressindicator"
            },
            {
              "type": "text",
              "text": "). Stream compression also enables tasks such as:"
            }
          ]
        },
        {
          "type": "unorderedList",
          "items": [
            {
              "content": [
                {
                  "type": "paragraph",
                  "inlineContent": [
                    {
                      "type": "text",
                      "text": "Decoding a compressed stream into a buffer with the ability to grow the buffer and resume decoding if the expanded stream is too large to fit, without repeating any work."
                    }
                  ]
                }
              ]
            },
            {
              "content": [
                {
                  "type": "paragraph",
                  "inlineContent": [
                    {
                      "type": "text",
                      "text": "Encoding a stream as pieces of it become available, without ever needing to create a buffer large enough to hold all the uncompressed data at one time."
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "level": 3,
          "type": "heading",
          "text": "Accept Dropped Files",
          "anchor": "3616411"
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "Register the app’s view, "
            },
            {
              "type": "codeVoice",
              "code": "DragDropCompressView"
            },
            {
              "type": "text",
              "text": ", as a destination for file URLs by adding "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/appkit/nsview/1483578-registerfordraggedtypes"
            },
            {
              "type": "text",
              "text": " to the "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/appkit/nsview/1483568-viewdidmovetosuperview"
            },
            {
              "type": "text",
              "text": " method:"
            }
          ]
        },
        {
          "type": "codeListing",
          "code": [
            "override func viewDidMoveToSuperview() {",
            "    registerForDraggedTypes([NSPasteboard.PasteboardType.fileURL])",
            "}"
          ],
          "syntax": "swift",
          "metadata": {
            "anchor": "3616384",
            "title": "Listing 1"
          }
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "After the user drops a conforming file onto the app, the view calls the "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/appkit/nsdraggingdestination/1415970-performdragoperation"
            },
            {
              "type": "text",
              "text": " method. Iterate over the dragged items inside "
            },
            {
              "type": "codeVoice",
              "code": "performDragOperation"
            },
            {
              "type": "text",
              "text": ", using "
            },
            {
              "type": "codeVoice",
              "code": "guard"
            },
            {
              "type": "text",
              "text": " to ensure each item is a "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/foundation/url"
            },
            {
              "type": "text",
              "text": " instance:"
            }
          ]
        },
        {
          "type": "codeListing",
          "code": [
            "sender.enumerateDraggingItems(options: [],",
            "                              for: nil,",
            "                              classes: [ NSURL.self ],",
            "                              searchOptions: [ .urlReadingFileURLsOnly: true ]) { (draggingItem, _, _) in",
            "    guard",
            "        let url = draggingItem.item as? URL else {",
            "            return",
            "    }"
          ],
          "syntax": "swift",
          "metadata": {
            "anchor": "3616385",
            "title": "Listing 2"
          }
        },
        {
          "level": 3,
          "type": "heading",
          "text": "Select a Compression Algorithm",
          "anchor": "3616412"
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "If speed and compression ratio are important, use "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/compression/compression_algorithm/compression_lzfse"
            },
            {
              "type": "text",
              "text": ":"
            }
          ]
        },
        {
          "type": "codeListing",
          "code": [
            "let encodeAlgorithm = COMPRESSION_LZFSE"
          ],
          "syntax": "swift",
          "metadata": {
            "anchor": "3616387",
            "title": "Listing 3"
          }
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "If you require interoperability with non-Apple devices, use "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/compression/compression_algorithm/compression_zlib"
            },
            {
              "type": "text",
              "text": " instead. For more information about other compression algorithms, see "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/compression/compression_algorithm"
            },
            {
              "type": "text",
              "text": "."
            }
          ]
        },
        {
          "level": 3,
          "type": "heading",
          "text": "Distinguish Between Compressed and Uncompressed Files",
          "anchor": "3616413"
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "Use the path extension to infer whether a file is already compressed, or if the file needs compressing. To simplify this process, create a failable initializer in an extension to the Compression framework’s "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/compression/compression_algorithm"
            },
            {
              "type": "text",
              "text": " structure:"
            }
          ]
        },
        {
          "type": "codeListing",
          "code": [
            "init?(name: String) {",
            "    switch name.lowercased() {",
            "    case \"lz4\":",
            "        self = COMPRESSION_LZ4",
            "    case \"zlib\":",
            "        self = COMPRESSION_ZLIB",
            "    case \"lzma\":",
            "        self = COMPRESSION_LZMA",
            "    case \"lzfse\":",
            "        self = COMPRESSION_LZFSE",
            "    default:",
            "        return nil",
            "    }",
            "}"
          ],
          "syntax": "swift",
          "metadata": {
            "anchor": "3616389",
            "title": "Listing 4"
          }
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "Use this new initializer to define the "
            },
            {
              "type": "codeVoice",
              "code": "algorithm"
            },
            {
              "type": "text",
              "text": " and "
            },
            {
              "type": "codeVoice",
              "code": "operation"
            },
            {
              "type": "text",
              "text": " constants:"
            }
          ]
        },
        {
          "type": "codeListing",
          "code": [
            "let algorithm: compression_algorithm",
            "let operation: compression_stream_operation",
            "                            ",
            "if let decodeAlgorithm = compression_algorithm(name: url.pathExtension) {",
            "    algorithm = decodeAlgorithm",
            "    operation = COMPRESSION_STREAM_DECODE",
            "} else {",
            "    algorithm = self.encodeAlgorithm",
            "    operation = COMPRESSION_STREAM_ENCODE",
            "}"
          ],
          "syntax": "swift",
          "metadata": {
            "anchor": "3616390",
            "title": "Listing 5"
          }
        },
        {
          "level": 3,
          "type": "heading",
          "text": "Define the Source and Destination File Handles",
          "anchor": "3616414"
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "The sample uses "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/foundation/nsfilehandle"
            },
            {
              "type": "text",
              "text": " instances to read from the source file and write to the destination file. Use optional binding to define the required file handles:"
            }
          ]
        },
        {
          "type": "codeListing",
          "code": [
            "if",
            "    let sourceFileHandle = try? FileHandle(forReadingFrom: url),",
            "    let sourceLength = FileHelper.fileSize(atURL: url),",
            "    let fileName = url.pathComponents.last,",
            "    let fileNameDeletingPathExtension = url.deletingPathExtension().pathComponents.last,",
            "    let destinationFileHandle = FileHandle.makeFileHandle(forWritingToFileNameInTempDirectory:",
            "        operation == COMPRESSION_STREAM_ENCODE",
            "            ? fileName + self.encodeAlgorithm.pathExtension",
            "            : fileNameDeletingPathExtension)",
            "{"
          ],
          "syntax": "swift",
          "metadata": {
            "anchor": "3616392",
            "title": "Listing 6"
          }
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "If the optional binding succeeded, the destination file handle points to the source filename with the compression algorithm appended as an extension (for compression), or the source filename with the compression name extension removed (for decompression). For example, the source file "
            },
            {
              "type": "codeVoice",
              "code": "MyCompressedFile.PDF.lzfse"
            },
            {
              "type": "text",
              "text": " would have a destination of "
            },
            {
              "type": "codeVoice",
              "code": "MyCompressedFile.PDF"
            },
            {
              "type": "text",
              "text": ", and "
            },
            {
              "type": "codeVoice",
              "code": "MyRawFile.PDF"
            },
            {
              "type": "text",
              "text": " would have a destination of "
            },
            {
              "type": "codeVoice",
              "code": "MyRawFile.PDF.lzfse"
            },
            {
              "type": "text",
              "text": "."
            }
          ]
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "Pass the source and destination file handles, with the operation and algorithm values to the helper function "
            },
            {
              "type": "codeVoice",
              "code": "streamingCompression"
            },
            {
              "type": "text",
              "text": ":"
            }
          ]
        },
        {
          "type": "codeListing",
          "code": [
            "Compressor.streamingCompression(operation: operation,",
            "                                sourceFileHandle: sourceFileHandle,",
            "                                destinationFileHandle: destinationFileHandle,",
            "                                algorithm: algorithm) {",
            "                                    self.progress.completedUnitCount = $0",
            "}"
          ],
          "syntax": "swift",
          "metadata": {
            "anchor": "3616393",
            "title": "Listing 7"
          }
        },
        {
          "level": 3,
          "type": "heading",
          "text": "Create a Destination Buffer",
          "anchor": "3616415"
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "The "
            },
            {
              "type": "codeVoice",
              "code": "streamingCompression"
            },
            {
              "type": "text",
              "text": " method iterates over the source data, encoding or decoding data in blocks based on the length defined by "
            },
            {
              "type": "codeVoice",
              "code": "bufferSize"
            },
            {
              "type": "text",
              "text": ". The method writes the result into the destination buffer, and writes the destination buffer data to the destination file handle. The following declares the buffer size and allocates the destination buffer:"
            }
          ]
        },
        {
          "type": "codeListing",
          "code": [
            "let bufferSize = 32_768",
            "let destinationBufferPointer = UnsafeMutablePointer<UInt8>.allocate(capacity: bufferSize)",
            "defer {",
            "    destinationBufferPointer.deallocate()",
            "}"
          ],
          "syntax": "swift",
          "metadata": {
            "anchor": "3616395",
            "title": "Listing 8"
          }
        },
        {
          "level": 3,
          "type": "heading",
          "text": "Create a Compression Stream",
          "anchor": "3616416"
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "The "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/compression/compression_stream"
            },
            {
              "type": "text",
              "text": " structure defines the source and destination pointers and sizes. To simplify the instantiation of a "
            },
            {
              "type": "codeVoice",
              "code": "compression_stream"
            },
            {
              "type": "text",
              "text": " structure, create an extension that allocates the required memory:"
            }
          ]
        },
        {
          "type": "codeListing",
          "code": [
            "extension compression_stream {",
            "    init() {",
            "        self = UnsafeMutablePointer<compression_stream>.allocate(capacity: 1).pointee",
            "    }",
            "}"
          ],
          "syntax": "swift",
          "metadata": {
            "anchor": "3616397",
            "title": "Listing 9"
          }
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "Use the following extension to declare and initialize the compression stream:"
            }
          ]
        },
        {
          "type": "codeListing",
          "code": [
            "var stream = compression_stream()",
            "var status = compression_stream_init(&stream, operation, algorithm)",
            "guard status != COMPRESSION_STATUS_ERROR else {",
            "    fatalError(\"Unable to initialize the compression stream.\")",
            "}"
          ],
          "syntax": "swift",
          "metadata": {
            "anchor": "3616398",
            "title": "Listing 10"
          }
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "After you’re finished with the "
            },
            {
              "type": "codeVoice",
              "code": "compression_stream"
            },
            {
              "type": "text",
              "text": " structure, it’s important that you free the memory allocated to it with "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/compression/1480978-compression_stream_destroy"
            },
            {
              "type": "text",
              "text": ". Use a defer block to ensure the memory is freed even if the "
            },
            {
              "type": "codeVoice",
              "code": "streamingCompression"
            },
            {
              "type": "text",
              "text": " method exits early:"
            }
          ]
        },
        {
          "type": "codeListing",
          "code": [
            "defer {",
            "    compression_stream_destroy(&stream)",
            "}"
          ],
          "syntax": "swift",
          "metadata": {
            "anchor": "3616399",
            "title": "Listing 11"
          }
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "With the compression stream inialized, set up the stream by defining its source and destination sizes and destination pointer:"
            }
          ]
        },
        {
          "type": "codeListing",
          "code": [
            "stream.src_size = 0",
            "stream.dst_ptr = destinationBufferPointer",
            "stream.dst_size = bufferSize"
          ],
          "syntax": "swift",
          "metadata": {
            "anchor": "3616400",
            "title": "Listing 12"
          }
        },
        {
          "level": 3,
          "type": "heading",
          "text": "Read the Source File Data Iteratively",
          "anchor": "3616417"
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "Use a "
            },
            {
              "type": "codeVoice",
              "code": "repeat-while"
            },
            {
              "type": "text",
              "text": " loop to manage the read-encode/decode-write process. If the stream’s source size is zero, read a block of data from the source file handle and point the stream’s source pointer to that data. If the read data is shorter than the buffer size, you can infer that you’re reading the last block of the source file and set the stream’s status to "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/compression/compression_stream_flags/compression_stream_finalize"
            },
            {
              "type": "text",
              "text": ":"
            }
          ]
        },
        {
          "type": "codeListing",
          "code": [
            "var sourceData: Data?",
            "repeat {",
            "    var flags = Int32(0)",
            "    ",
            "    // If this iteration has consumed all of the source data,",
            "    // read a new tempData buffer from the input file.",
            "    if stream.src_size == 0 {",
            "        sourceData = sourceFileHandle.readData(ofLength: bufferSize)",
            "        ",
            "        stream.src_size = sourceData!.count",
            "        if sourceData!.count < bufferSize {",
            "            flags = Int32(COMPRESSION_STREAM_FINALIZE.rawValue)",
            "        }",
            "    }"
          ],
          "syntax": "swift",
          "metadata": {
            "anchor": "3616402",
            "title": "Listing 13"
          }
        },
        {
          "level": 3,
          "type": "heading",
          "text": "Compress or Decompress the Dragged File",
          "anchor": "3616418"
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "Use "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/compression/1480976-compression_stream_process"
            },
            {
              "type": "text",
              "text": " to encode or decode the current block:"
            }
          ]
        },
        {
          "type": "codeListing",
          "code": [
            "if let sourceData = sourceData {",
            "    let count = sourceData.count",
            "    ",
            "    sourceData.withUnsafeBytes {",
            "        let baseAddress = $0.bindMemory(to: UInt8.self).baseAddress!",
            "        ",
            "        stream.src_ptr = baseAddress.advanced(by: count - stream.src_size)",
            "        status = compression_stream_process(&stream, flags)",
            "    }",
            "}"
          ],
          "syntax": "swift",
          "metadata": {
            "anchor": "3616404",
            "title": "Listing 14"
          }
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "On return, "
            },
            {
              "type": "codeVoice",
              "code": "destinationBufferPointer"
            },
            {
              "type": "text",
              "text": " points to the encoded or decoded data."
            }
          ]
        },
        {
          "level": 3,
          "type": "heading",
          "text": "Write Encoded or Decoded Data to a Destination File",
          "anchor": "3616419"
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "Check the status returned by "
            },
            {
              "type": "codeVoice",
              "code": "compression_stream_process"
            },
            {
              "type": "text",
              "text": ", if it’s either "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/compression/compression_status/compression_status_ok"
            },
            {
              "type": "text",
              "text": " or "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/compression/compression_status/compression_status_end"
            },
            {
              "type": "text",
              "text": ", you can write the destination data to the destination file handler:"
            }
          ]
        },
        {
          "type": "codeListing",
          "code": [
            "switch status {",
            "case COMPRESSION_STATUS_OK,",
            "     COMPRESSION_STATUS_END:",
            "    ",
            "    // Get the number of bytes put in the destination buffer. This is the difference between",
            "    // stream.dst_size before the call (here bufferSize), and stream.dst_size after the call.",
            "    let count = bufferSize - stream.dst_size",
            "    ",
            "    let outputData = Data(bytesNoCopy: destinationBufferPointer,",
            "                          count: count,",
            "                          deallocator: .none)",
            "    ",
            "    // Write all produced bytes to the output file.",
            "    destinationFileHandle.write(outputData)",
            "    ",
            "    // Reset the stream to receive the next batch of output.",
            "    stream.dst_ptr = destinationBufferPointer",
            "    stream.dst_size = bufferSize"
          ],
          "syntax": "swift",
          "metadata": {
            "anchor": "3616406",
            "title": "Listing 15"
          }
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "This read-encode/decode-write loop continues while "
            },
            {
              "type": "codeVoice",
              "code": "status"
            },
            {
              "type": "text",
              "text": " equals "
            },
            {
              "type": "codeVoice",
              "code": "COMPRESSION_STATUS_OK"
            },
            {
              "type": "text",
              "text": "."
            }
          ]
        },
        {
          "level": 3,
          "type": "heading",
          "text": "Close the Source and Destination Files",
          "anchor": "3616420"
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "After you’re finished with the source and destination file handles, close them with the "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/foundation/nsfilehandle/1413393-closefile"
            },
            {
              "type": "text",
              "text": " method:"
            }
          ]
        },
        {
          "type": "codeListing",
          "code": [
            "sourceFileHandle.closeFile()",
            "destinationFileHandle.closeFile()"
          ],
          "syntax": "swift",
          "metadata": {
            "anchor": "3616408",
            "title": "Listing 16"
          }
        }
      ]
    }
  ],
  "legalNotices": {
    "copyright": "Copyright &copy; 2020 Apple Inc. All rights reserved.",
    "termsOfUse": "https://www.apple.com/legal/internet-services/terms/site.html",
    "privacyPolicy": "https://www.apple.com/privacy/privacy-policy"
  }
}