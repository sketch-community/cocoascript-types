{
  "abstract": [
    {
      "type": "text",
      "text": "An operation that fetches database changes."
    }
  ],
  "documentVersion": 0,
  "hierarchy": {
    "paths": [
      [
        "doc://com.apple.documentation/documentation/technologies",
        "doc://com.apple.documentation/documentation/cloudkit",
        "doc://com.apple.documentation/documentation/cloudkit/remote_records"
      ]
    ]
  },
  "identifier": {
    "url": "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation",
    "interfaceLanguage": "occ"
  },
  "legacy_identifier": 1640388,
  "kind": "symbol",
  "metadata": {
    "title": "CKFetchDatabaseChangesOperation",
    "role": "symbol",
    "roleHeading": "Class",
    "modules": [
      {
        "name": "CloudKit"
      }
    ],
    "platforms": [
      {
        "name": "iOS",
        "introducedAt": "10.0",
        "current": "15.2"
      },
      {
        "name": "iPadOS",
        "introducedAt": "10.0",
        "current": "15.2"
      },
      {
        "name": "macOS",
        "introducedAt": "10.12",
        "current": "12.1"
      },
      {
        "name": "Mac Catalyst",
        "introducedAt": "13.0",
        "current": "15.2"
      },
      {
        "name": "tvOS",
        "introducedAt": "10.0",
        "current": "15.2"
      },
      {
        "name": "watchOS",
        "introducedAt": "3.0",
        "current": "8.3"
      }
    ],
    "externalID": "c:objc(cs)CKFetchDatabaseChangesOperation",
    "symbolKind": "cl"
  },
  "schemaVersion": {
    "major": 0,
    "minor": 1,
    "patch": 0
  },
  "sections": [],
  "variants": [
    {
      "traits": [
        {
          "interfaceLanguage": "occ"
        }
      ],
      "paths": [
        "documentation/cloudkit/ckfetchdatabasechangesoperation"
      ]
    },
    {
      "traits": [
        {
          "interfaceLanguage": "swift"
        }
      ],
      "paths": [
        "documentation/cloudkit/ckfetchdatabasechangesoperation"
      ]
    }
  ],
  "references": {
    "doc://com.apple.documentation/documentation/cloudkit": {
      "title": "CloudKit",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit",
      "url": "/documentation/cloudkit",
      "type": "topic",
      "kind": "symbol",
      "role": "collection"
    },
    "doc://com.apple.documentation/documentation/cloudkit/remote_records": {
      "title": "Remote Records",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/remote_records",
      "url": "/documentation/cloudkit/remote_records",
      "type": "topic",
      "kind": "article",
      "role": "collectionGroup"
    },
    "doc://com.apple.documentation/documentation/objectivec/nil-2gl": {
      "title": "nil",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/objectivec/nil-2gl",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/objectivec/nil-2gl"
    },
    "doc://com.apple.documentation/documentation/foundation/nssecurecoding": {
      "title": "NSSecureCoding",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/foundation/nssecurecoding",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/foundation/nssecurecoding"
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckfetchrecordzonechangesoperation": {
      "title": "CKFetchRecordZoneChangesOperation",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckfetchrecordzonechangesoperation",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/ckfetchrecordzonechangesoperation"
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckdatabasesubscription": {
      "title": "CKDatabaseSubscription",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckdatabasesubscription",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/ckdatabasesubscription",
      "abstract": [
        {
          "type": "text",
          "text": "A subscription that generates push notifications when CloudKit modifies records in a database."
        }
      ]
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/1640391-recordzonewithidchangedblock": {
      "title": "recordZoneWithIDChangedBlock",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/1640391-recordzonewithidchangedblock",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/ckfetchdatabasechangesoperation/1640391-recordzonewithidchangedblock",
      "abstract": [
        {
          "type": "text",
          "text": "The block to execute with a single record zone change."
        }
      ]
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation#3735871": {
      "title": "Listing 1",
      "type": "section",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation#3735871",
      "kind": "article",
      "role": "codeListing",
      "url": "/documentation/cloudkit/ckfetchdatabasechangesoperation#3735871"
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckdatabaseoperation": {
      "title": "CKDatabaseOperation",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckdatabaseoperation",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/ckdatabaseoperation"
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/1640502-initwithpreviousserverchangetoke": {
      "title": "initWithPreviousServerChangeToken:",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/1640502-initwithpreviousserverchangetoke",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/ckfetchdatabasechangesoperation/1640502-initwithpreviousserverchangetoke",
      "abstract": [
        {
          "type": "text",
          "text": "Creates an operation for fetching database changes. "
        }
      ],
      "fragments": [
        {
          "kind": "text",
          "text": "- "
        },
        {
          "kind": "identifier",
          "text": "initWithPreviousServerChangeToken:"
        }
      ]
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/2715838-init": {
      "title": "init",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/2715838-init",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/ckfetchdatabasechangesoperation/2715838-init",
      "abstract": [
        {
          "type": "text",
          "text": "Creates an empty fetch database changes operation."
        }
      ],
      "fragments": [
        {
          "kind": "text",
          "text": "- "
        },
        {
          "kind": "identifier",
          "text": "init"
        }
      ]
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/1640473-fetchallchanges": {
      "title": "fetchAllChanges",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/1640473-fetchallchanges",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/ckfetchdatabasechangesoperation/1640473-fetchallchanges",
      "abstract": [
        {
          "type": "text",
          "text": "A Boolean value that indicates whether to send repeated requests to the server. "
        }
      ]
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/1640522-previousserverchangetoken": {
      "title": "previousServerChangeToken",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/1640522-previousserverchangetoken",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/ckfetchdatabasechangesoperation/1640522-previousserverchangetoken",
      "abstract": [
        {
          "type": "text",
          "text": "The server change token."
        }
      ]
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/1640520-resultslimit": {
      "title": "resultsLimit",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/1640520-resultslimit",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/ckfetchdatabasechangesoperation/1640520-resultslimit",
      "abstract": [
        {
          "type": "text",
          "text": "The maximum number of results that the operation fetches. "
        }
      ]
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/1640428-recordzonewithidwasdeletedblock": {
      "title": "recordZoneWithIDWasDeletedBlock",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/1640428-recordzonewithidwasdeletedblock",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/ckfetchdatabasechangesoperation/1640428-recordzonewithidwasdeletedblock",
      "abstract": [
        {
          "type": "text",
          "text": "The block to execute when a record zone no longer exists."
        }
      ]
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/3746820-recordzonewithidwasdeletedduetou": {
      "title": "recordZoneWithIDWasDeletedDueToUserEncryptedDataResetBlock",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/3746820-recordzonewithidwasdeletedduetou",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/ckfetchdatabasechangesoperation/3746820-recordzonewithidwasdeletedduetou",
      "abstract": [
        {
          "type": "text",
          "text": "The block to execute when a user-invoked account reset deletes a record zone."
        }
      ]
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/2866207-recordzonewithidwaspurgedblock": {
      "title": "recordZoneWithIDWasPurgedBlock",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/2866207-recordzonewithidwaspurgedblock",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/ckfetchdatabasechangesoperation/2866207-recordzonewithidwaspurgedblock",
      "abstract": [
        {
          "type": "text",
          "text": "The block to execute when CloudKit purges a record zone. "
        }
      ]
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/1640467-changetokenupdatedblock": {
      "title": "changeTokenUpdatedBlock",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/1640467-changetokenupdatedblock",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/ckfetchdatabasechangesoperation/1640467-changetokenupdatedblock",
      "abstract": [
        {
          "type": "text",
          "text": "The block to execute when the change token updates."
        }
      ]
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/1640434-fetchdatabasechangescompletionbl": {
      "title": "fetchDatabaseChangesCompletionBlock",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/1640434-fetchdatabasechangescompletionbl",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/ckfetchdatabasechangesoperation/1640434-fetchdatabasechangescompletionbl",
      "abstract": [
        {
          "type": "text",
          "text": "The block to execute when the operation finishes."
        }
      ]
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckdatabasenotification": {
      "title": "CKDatabaseNotification",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckdatabasenotification",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/ckdatabasenotification",
      "abstract": [
        {
          "type": "text",
          "text": "A notification that triggers when the contents of a database change."
        }
      ]
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation": {
      "title": "CKFetchDatabaseChangesOperation",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/ckfetchdatabasechangesoperation",
      "abstract": [
        {
          "type": "text",
          "text": "An operation that fetches database changes."
        }
      ]
    },
    "doc://com.apple.documentation/documentation/technologies": {
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/technologies",
      "url": "/documentation/technologies",
      "kind": "technologies",
      "title": "Technologies"
    }
  },
  "relationshipsSections": [
    {
      "kind": "relationships",
      "title": "Inherits From",
      "type": "inheritsFrom",
      "identifiers": [
        "doc://com.apple.documentation/documentation/cloudkit/ckdatabaseoperation"
      ]
    }
  ],
  "topicSections": [
    {
      "kind": "taskGroup",
      "title": "Creating an Operation",
      "identifiers": [
        "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/1640502-initwithpreviousserverchangetoke",
        "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/2715838-init"
      ],
      "anchor": "2557843"
    },
    {
      "kind": "taskGroup",
      "title": "Configuring the Operation",
      "identifiers": [
        "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/1640473-fetchallchanges",
        "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/1640522-previousserverchangetoken",
        "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/1640520-resultslimit"
      ],
      "anchor": "2530658"
    },
    {
      "kind": "taskGroup",
      "title": "Processing the Operation’s Results",
      "identifiers": [
        "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/1640391-recordzonewithidchangedblock",
        "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/1640428-recordzonewithidwasdeletedblock",
        "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/3746820-recordzonewithidwasdeletedduetou",
        "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/2866207-recordzonewithidwaspurgedblock",
        "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/1640467-changetokenupdatedblock",
        "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/1640434-fetchdatabasechangescompletionbl"
      ],
      "anchor": "2530651"
    }
  ],
  "seeAlsoSections": [
    {
      "identifiers": [
        "doc://com.apple.documentation/documentation/cloudkit/ckdatabasesubscription",
        "doc://com.apple.documentation/documentation/cloudkit/ckdatabasenotification"
      ],
      "title": "Database Changes",
      "generated": true
    }
  ],
  "primaryContentSections": [
    {
      "kind": "declarations",
      "declarations": [
        {
          "languages": [
            "occ"
          ],
          "tokens": [
            {
              "kind": "keyword",
              "text": "@interface"
            },
            {
              "kind": "text",
              "text": " "
            },
            {
              "kind": "identifier",
              "text": "CKFetchDatabaseChangesOperation"
            },
            {
              "kind": "text",
              "text": " : "
            },
            {
              "kind": "typeIdentifier",
              "preciseIdentifier": "c:objc(cs)CKDatabaseOperation",
              "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckdatabaseoperation",
              "text": "CKDatabaseOperation"
            }
          ],
          "platforms": [
            "iOS",
            "iPadOS",
            "macOS",
            "Mac Catalyst",
            "tvOS",
            "watchOS"
          ]
        }
      ]
    },
    {
      "kind": "content",
      "content": [
        {
          "anchor": "overview",
          "level": 2,
          "text": "Overview",
          "type": "heading"
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "Use this operation to fetch all record zone changes in a database. This includes new record zones, changed zones — including deleted or purged zones — and zones that contain record changes. When you create the operation, you provide a server change token, which is an opaque token that represents a specific point in the database’s history. CloudKit returns only the changes that occur after that point. For your app’s first fetch, or to refetch every change in the database’s history, use "
            },
            {
              "type": "reference",
              "isActive": false,
              "identifier": "doc://com.apple.documentation/documentation/objectivec/nil-2gl"
            },
            {
              "type": "text",
              "text": " instead."
            }
          ]
        },
        {
          "type": "aside",
          "content": [
            {
              "type": "paragraph",
              "inlineContent": [
                {
                  "type": "text",
                  "text": "Only private and shared databases support this operation. If you attempt to execute this operation in the public database, CloudKit returns an error."
                }
              ]
            }
          ],
          "style": "note",
          "name": "Note"
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "The operation yields new change tokens during its execution, and issues a final change token when it completes without error. The change tokens conform to "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/foundation/nssecurecoding"
            },
            {
              "type": "text",
              "text": " and are safe to cache on-disk. This operation’s tokens aren’t compatible with "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckfetchrecordzonechangesoperation"
            },
            {
              "type": "text",
              "text": " so you should segregate them in your cache. Don’t infer any behavior or order from the tokens’ contents."
            }
          ]
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "When your app launches for the first time, use this operation to fetch all the database’s changes. Cache the results on-device and use "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckdatabasesubscription"
            },
            {
              "type": "text",
              "text": " to subscribe to future changes. Fetch those changes on receipt of the push notifications the subscription generates. It’s not necessary to perform a fetch each time your app launches, or to schedule fetches at regular intervals."
            }
          ]
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "The operation calls "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckfetchdatabasechangesoperation/1640391-recordzonewithidchangedblock"
            },
            {
              "type": "text",
              "text": " for each zone that contains record changes. It also calls it for new and modified record zones. Store the IDs that CloudKit provides to this callback. Use those IDs with "
            },
            {
              "type": "reference",
              "isActive": false,
              "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckfetchrecordzonechangesoperation"
            },
            {
              "type": "text",
              "text": " to fetch the corresponding changes. There are similar callbacks for deleted and purged record zones."
            }
          ]
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "To run the operation, add it to the corresponding database’s operation queue. The operation executes its callbacks on a private serial queue."
            }
          ]
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "The following example shows how to create the operation, configure its callbacks, and execute it. For brevity, it omits the delete and purge callbacks."
            }
          ]
        },
        {
          "type": "codeListing",
          "code": [
            "// Create a fetch operation using the server change",
            "// token from the previous fetch.",
            "CKFetchDatabaseChangesOperation *operation =",
            "    [[CKFetchDatabaseChangesOperation alloc]",
            "     initWithPreviousServerChangeToken:token];",
            "    ",
            "// Collect the IDs of the modified record zones.",
            "operation.recordZoneWithIDChangedBlock = ^(CKRecordZoneID *recordZoneID) {",
            "    [recordZoneIDs addObject:recordZoneID];",
            "};",
            "    ",
            "// Process any change tokens that CloudKit provides",
            "// as the operation runs.",
            "operation.changeTokenUpdatedBlock = ^(CKServerChangeToken *newToken) {",
            "    tokenHandler(newToken);",
            "};",
            "    ",
            "// Store the final change token and pass the IDs of the",
            "// modified record zones for further processing.",
            "operation.fetchDatabaseChangesCompletionBlock =",
            "    ^(CKServerChangeToken *newToken, BOOL more, NSError *error) {",
            "    if (error) {",
            "        // Handle the error.",
            "    } else {",
            "        tokenHandler(newToken);",
            "        recordZonesHandler(recordZoneIDs);",
            "    }",
            "};",
            "    ",
            "// Set an appropriate QoS and add the operation to the shared",
            "// database's operation queue to execute it.",
            "operation.qualityOfService = NSQualityOfServiceUtility;",
            "[CKContainer.defaultContainer.sharedCloudDatabase addOperation:operation];"
          ],
          "syntax": "swift",
          "metadata": {
            "anchor": "3735871",
            "title": "Listing 1"
          }
        },
        {
          "type": "paragraph",
          "inlineContent": []
        }
      ]
    }
  ],
  "legalNotices": {
    "copyright": "Copyright &copy; 2021 Apple Inc. All rights reserved.",
    "termsOfUse": "https://www.apple.com/legal/internet-services/terms/site.html",
    "privacyPolicy": "https://www.apple.com/privacy/privacy-policy"
  }
}