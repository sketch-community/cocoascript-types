{
  "abstract": [
    {
      "type": "text",
      "text": "A subscription that generates push notifications when CloudKit modifies records that match a predicate."
    }
  ],
  "documentVersion": 0,
  "hierarchy": {
    "paths": [
      [
        "doc://com.apple.documentation/documentation/technologies",
        "doc://com.apple.documentation/documentation/cloudkit",
        "doc://com.apple.documentation/documentation/cloudkit/remote_records"
      ]
    ]
  },
  "identifier": {
    "url": "doc://com.apple.documentation/documentation/cloudkit/ckquerysubscription",
    "interfaceLanguage": "occ"
  },
  "legacy_identifier": 1640444,
  "kind": "symbol",
  "metadata": {
    "title": "CKQuerySubscription",
    "role": "symbol",
    "roleHeading": "Class",
    "modules": [
      {
        "name": "CloudKit"
      }
    ],
    "platforms": [
      {
        "name": "iOS",
        "introducedAt": "10.0",
        "current": "15.2"
      },
      {
        "name": "iPadOS",
        "introducedAt": "10.0",
        "current": "15.2"
      },
      {
        "name": "macOS",
        "introducedAt": "10.12",
        "current": "12.1"
      },
      {
        "name": "Mac Catalyst",
        "introducedAt": "13.0",
        "current": "15.2"
      },
      {
        "name": "tvOS",
        "introducedAt": "10.0",
        "current": "15.2"
      },
      {
        "name": "watchOS",
        "introducedAt": "6.0",
        "current": "8.3"
      }
    ],
    "externalID": "c:objc(cs)CKQuerySubscription",
    "symbolKind": "cl"
  },
  "schemaVersion": {
    "major": 0,
    "minor": 1,
    "patch": 0
  },
  "sections": [],
  "variants": [
    {
      "traits": [
        {
          "interfaceLanguage": "occ"
        }
      ],
      "paths": [
        "documentation/cloudkit/ckquerysubscription"
      ]
    },
    {
      "traits": [
        {
          "interfaceLanguage": "swift"
        }
      ],
      "paths": [
        "documentation/cloudkit/ckquerysubscription"
      ]
    }
  ],
  "references": {
    "doc://com.apple.documentation/documentation/cloudkit": {
      "title": "CloudKit",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit",
      "url": "/documentation/cloudkit",
      "type": "topic",
      "kind": "symbol",
      "role": "collection"
    },
    "doc://com.apple.documentation/documentation/cloudkit/remote_records": {
      "title": "Remote Records",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/remote_records",
      "url": "/documentation/cloudkit/remote_records",
      "type": "topic",
      "kind": "article",
      "role": "collectionGroup"
    },
    "doc://com.apple.documentation/documentation/cloudkit/enabling_cloudkit_in_your_app": {
      "title": "Enabling CloudKit in Your App",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/enabling_cloudkit_in_your_app",
      "kind": "article",
      "role": "article",
      "url": "/documentation/cloudkit/enabling_cloudkit_in_your_app"
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckquerysubscription/1640390-zoneid": {
      "title": "zoneID",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckquerysubscription/1640390-zoneid",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/ckquerysubscription/1640390-zoneid",
      "abstract": [
        {
          "type": "text",
          "text": "The ID of the record zone that the subscription queries."
        }
      ]
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckquery": {
      "title": "CKQuery",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckquery",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/ckquery"
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckmodifysubscriptionsoperation": {
      "title": "CKModifySubscriptionsOperation",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckmodifysubscriptionsoperation",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/ckmodifysubscriptionsoperation"
    },
    "doc://com.apple.documentation/documentation/foundation/nsuserdefaults": {
      "title": "NSUserDefaults",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/foundation/nsuserdefaults",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/foundation/nsuserdefaults"
    },
    "doc://com.apple.documentation/documentation/cloudkit/cksubscription/1514948-notificationinfo": {
      "title": "notificationInfo",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/cksubscription/1514948-notificationinfo",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/cksubscription/1514948-notificationinfo"
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckqueryoperation": {
      "title": "CKQueryOperation",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckqueryoperation",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/ckqueryoperation"
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckqueryoperation/1515269-zoneid": {
      "title": "zoneID",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckqueryoperation/1515269-zoneid",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/ckqueryoperation/1515269-zoneid"
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckquerysubscription#3735561": {
      "title": "Listing 1",
      "type": "section",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckquerysubscription#3735561",
      "kind": "article",
      "role": "codeListing",
      "url": "/documentation/cloudkit/ckquerysubscription#3735561"
    },
    "doc://com.apple.documentation/documentation/cloudkit/cksubscription": {
      "title": "CKSubscription",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/cksubscription",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/cksubscription"
    },
    "doc://com.apple.documentation/documentation/foundation/nssecurecoding": {
      "title": "NSSecureCoding",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/foundation/nssecurecoding",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/foundation/nssecurecoding"
    },
    "doc://com.apple.documentation/documentation/foundation/nscopying": {
      "title": "NSCopying",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/foundation/nscopying",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/foundation/nscopying"
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckquerysubscription/1640466-initwithrecordtype": {
      "title": "initWithRecordType:predicate:options:",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckquerysubscription/1640466-initwithrecordtype",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/ckquerysubscription/1640466-initwithrecordtype",
      "abstract": [
        {
          "type": "text",
          "text": "Creates a query-based subscription that queries records of a specific type."
        }
      ],
      "fragments": [
        {
          "kind": "text",
          "text": "- "
        },
        {
          "kind": "identifier",
          "text": "initWithRecordType:predicate:options:"
        }
      ]
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckquerysubscription/1640505-initwithrecordtype": {
      "title": "initWithRecordType:predicate:subscriptionID:options:",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckquerysubscription/1640505-initwithrecordtype",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/ckquerysubscription/1640505-initwithrecordtype",
      "abstract": [
        {
          "type": "text",
          "text": "Creates a named query-based subscription that queries records of a specific type."
        }
      ],
      "fragments": [
        {
          "kind": "text",
          "text": "- "
        },
        {
          "kind": "identifier",
          "text": "initWithRecordType:predicate:subscriptionID:options:"
        }
      ]
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckquerysubscription/3547081-initwithcoder": {
      "title": "initWithCoder:",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckquerysubscription/3547081-initwithcoder",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/ckquerysubscription/3547081-initwithcoder",
      "abstract": [
        {
          "type": "text",
          "text": "Creates a query-based subscription from a serialized instance."
        }
      ],
      "fragments": [
        {
          "kind": "text",
          "text": "- "
        },
        {
          "kind": "identifier",
          "text": "initWithCoder:"
        }
      ]
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckquerysubscription/1640485-predicate": {
      "title": "predicate",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckquerysubscription/1640485-predicate",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/ckquerysubscription/1640485-predicate",
      "abstract": [
        {
          "type": "text",
          "text": "The matching criteria to apply to records."
        }
      ]
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckquerysubscription/1640414-querysubscriptionoptions": {
      "title": "querySubscriptionOptions",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckquerysubscription/1640414-querysubscriptionoptions",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/ckquerysubscription/1640414-querysubscriptionoptions",
      "abstract": [
        {
          "type": "text",
          "text": "Options that define the behavior of the subscription."
        }
      ]
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckquerysubscriptionoptions": {
      "title": "CKQuerySubscriptionOptions",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckquerysubscriptionoptions",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/ckquerysubscriptionoptions",
      "abstract": [
        {
          "type": "text",
          "text": "Configuration options for a query subscription."
        }
      ]
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckquerysubscription/1640393-recordtype": {
      "title": "recordType",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckquerysubscription/1640393-recordtype",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/ckquerysubscription/1640393-recordtype",
      "abstract": [
        {
          "type": "text",
          "text": "The type of record that the subscription queries."
        }
      ]
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckquerysubscription": {
      "title": "CKQuerySubscription",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckquerysubscription",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/ckquerysubscription",
      "abstract": [
        {
          "type": "text",
          "text": "A subscription that generates push notifications when CloudKit modifies records that match a predicate."
        }
      ]
    },
    "doc://com.apple.documentation/documentation/cloudkit/ckquerynotification": {
      "title": "CKQueryNotification",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckquerynotification",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/cloudkit/ckquerynotification",
      "abstract": [
        {
          "type": "text",
          "text": "A notification that triggers when a record that matches the subscription’s predicate changes."
        }
      ]
    },
    "doc://com.apple.documentation/documentation/technologies": {
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/technologies",
      "url": "/documentation/technologies",
      "kind": "technologies",
      "title": "Technologies"
    }
  },
  "relationshipsSections": [
    {
      "kind": "relationships",
      "title": "Inherits From",
      "type": "inheritsFrom",
      "identifiers": [
        "doc://com.apple.documentation/documentation/cloudkit/cksubscription"
      ]
    },
    {
      "kind": "relationships",
      "title": "Conforms To",
      "type": "conformsTo",
      "identifiers": [
        "doc://com.apple.documentation/documentation/foundation/nscopying",
        "doc://com.apple.documentation/documentation/foundation/nssecurecoding"
      ]
    }
  ],
  "topicSections": [
    {
      "kind": "taskGroup",
      "title": "Creating a Subscription",
      "identifiers": [
        "doc://com.apple.documentation/documentation/cloudkit/ckquerysubscription/1640466-initwithrecordtype",
        "doc://com.apple.documentation/documentation/cloudkit/ckquerysubscription/1640505-initwithrecordtype",
        "doc://com.apple.documentation/documentation/cloudkit/ckquerysubscription/3547081-initwithcoder"
      ],
      "anchor": "2557842"
    },
    {
      "kind": "taskGroup",
      "title": "Accessing the Subscription Search Parameters",
      "identifiers": [
        "doc://com.apple.documentation/documentation/cloudkit/ckquerysubscription/1640485-predicate",
        "doc://com.apple.documentation/documentation/cloudkit/ckquerysubscription/1640414-querysubscriptionoptions",
        "doc://com.apple.documentation/documentation/cloudkit/ckquerysubscriptionoptions"
      ],
      "anchor": "2530639"
    },
    {
      "kind": "taskGroup",
      "title": "Accessing the Subscription Metadata",
      "identifiers": [
        "doc://com.apple.documentation/documentation/cloudkit/ckquerysubscription/1640393-recordtype",
        "doc://com.apple.documentation/documentation/cloudkit/ckquerysubscription/1640390-zoneid"
      ],
      "anchor": "2530641"
    }
  ],
  "seeAlsoSections": [
    {
      "identifiers": [
        "doc://com.apple.documentation/documentation/cloudkit/ckquerynotification"
      ],
      "title": "Predicate-Driven Changes",
      "generated": true
    }
  ],
  "primaryContentSections": [
    {
      "kind": "declarations",
      "declarations": [
        {
          "languages": [
            "occ"
          ],
          "tokens": [
            {
              "kind": "keyword",
              "text": "@interface"
            },
            {
              "kind": "text",
              "text": " "
            },
            {
              "kind": "identifier",
              "text": "CKQuerySubscription"
            },
            {
              "kind": "text",
              "text": " : "
            },
            {
              "kind": "typeIdentifier",
              "preciseIdentifier": "c:objc(cs)CKSubscription",
              "identifier": "doc://com.apple.documentation/documentation/cloudkit/cksubscription",
              "text": "CKSubscription"
            }
          ],
          "platforms": [
            "iOS",
            "iPadOS",
            "macOS",
            "Mac Catalyst",
            "tvOS",
            "watchOS"
          ]
        }
      ]
    },
    {
      "kind": "content",
      "content": [
        {
          "anchor": "overview",
          "level": 2,
          "text": "Overview",
          "type": "heading"
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "Subscriptions track the creation, modification, and deletion of records in a database, and are fundamental in keeping data on the user’s device up to date. A subscription applies only to the user that creates it. When a subscription registers a change, such as CloudKit saving a new record, it sends push notifications to the user’s devices to inform your app about the change. You can then fetch the changes and cache them on-device. When appropriate, the server excludes the device where the change originates."
            }
          ]
        },
        {
          "type": "aside",
          "content": [
            {
              "type": "paragraph",
              "inlineContent": [
                {
                  "type": "text",
                  "text": "You don’t need to explicitly enable push notifications for your App ID to receive subscription notifications. Xcode automatically adds the entitlement when you enable the CloudKit capability. For more information, see "
                },
                {
                  "type": "reference",
                  "isActive": true,
                  "identifier": "doc://com.apple.documentation/documentation/cloudkit/enabling_cloudkit_in_your_app"
                },
                {
                  "type": "text",
                  "text": ". To use silent push notifications, add the Background Modes capability in your Xcode project and then select the “Background fetch” and “Remote notifications” options."
                }
              ]
            }
          ],
          "style": "note",
          "name": "Note"
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "Query subscriptions execute whenever a change occurs in a database that matches the predicate and options you specify. You scope a query subscription to an individual record type that you provide during initialization. You can set the subscription’s "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckquerysubscription/1640390-zoneid"
            },
            {
              "type": "text",
              "text": " property to further specialize the subscription to a specific record zone in the database. This limits the scope of the subscription to only track changes in that record zone and reduces the number of notifications it generates. For more information about defining CloudKit-compatible predicates, see "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckquery"
            },
            {
              "type": "text",
              "text": "."
            }
          ]
        },
        {
          "type": "aside",
          "content": [
            {
              "type": "paragraph",
              "inlineContent": [
                {
                  "type": "text",
                  "text": "Only public and private databases support query subscriptions. If you attempt to save a database subscription in the shared database, CloudKit returns an error."
                }
              ]
            }
          ],
          "style": "note",
          "name": "Note"
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "Create any subscriptions on your app’s first launch. After you initialize a subscription, save it to the server using "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckmodifysubscriptionsoperation"
            },
            {
              "type": "text",
              "text": ". When the operation completes, record that state on-device (in "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/foundation/nsuserdefaults"
            },
            {
              "type": "text",
              "text": ", for example). You can then check that state on subsequent launches to prevent unnecessary trips to the server."
            }
          ]
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "To configure the notification the subscription generates, set the subscription’s "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/cloudkit/cksubscription/1514948-notificationinfo"
            },
            {
              "type": "text",
              "text": " property. Because the system coalesces notifications, don’t rely on them for specific changes. CloudKit can omit data to keep the payload size under the APNs size limit. Consider notifications an indication of remote changes and use "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckqueryoperation"
            },
            {
              "type": "text",
              "text": " to fetch the changed records. Create the operation with an instance of "
            },
            {
              "type": "reference",
              "isActive": false,
              "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckquery"
            },
            {
              "type": "text",
              "text": " that you configure with the same record type and predicate as the subscription. If you limit the subscription to a specific record zone, set the operation’s "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckqueryoperation/1515269-zoneid"
            },
            {
              "type": "text",
              "text": " property to that record zone’s ID. Because "
            },
            {
              "type": "reference",
              "isActive": false,
              "identifier": "doc://com.apple.documentation/documentation/cloudkit/ckqueryoperation"
            },
            {
              "type": "text",
              "text": " doesn’t employ server change tokens, dispose of any records you cache on-device and use the query’s results instead."
            }
          ]
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "The example below shows how to create a query subscription in the user’s private database, configure the notifications it generates — in this case, silent push notifications — and then save that subscription to the server:"
            }
          ]
        },
        {
          "type": "codeListing",
          "code": [
            "// Only proceed if the subscription doesn't already exist.",
            "if([[NSUserDefaults standardUserDefaults]",
            "    boolForKey:@\"didCreateQuerySubscription\"] == NO) {",
            "        ",
            "// Define a predicate that matches records with a tags field",
            "// that contains the word 'Swift'.",
            "NSPredicate *predicate = [NSPredicate predicateWithFormat:",
            "                          @\"tags CONTAINS 'Swift'\"];",
            "        ",
            "// Create a subscription and scope it to the 'FeedItem' record type.",
            "// Provide a unique identifier for the subscription and declare the",
            "// circumstances for invoking it.",
            "CKQuerySubscriptionOptions options = ",
            "    CKQuerySubscriptionOptionsFiresOnRecordCreation;",
            "CKQuerySubscription *subscription = [[CKQuerySubscription alloc]",
            "                                     initWithRecordType:@\"FeedItem\"",
            "                                     predicate:predicate",
            "                                     subscriptionID:@\"tagged-feed-changes\"",
            "                                     options:options];",
            "        ",
            "// Further specialize the subscription to only evaluate",
            "// records in a specific record zone",
            "subscription.zoneID = recordZone.zoneID;",
            "        ",
            "// Configure the notification so that the system delivers it silently",
            "// and, therefore, doesn't require permission from the user.",
            "CKNotificationInfo *notificationInfo = [CKNotificationInfo new];",
            "notificationInfo.shouldSendContentAvailable = YES;",
            "subscription.notificationInfo = notificationInfo;",
            "        ",
            "// Create an operation that saves the subscription to the server.",
            "CKModifySubscriptionsOperation *operation =",
            "    [[CKModifySubscriptionsOperation alloc]",
            "     initWithSubscriptionsToSave:@[subscription]",
            "     subscriptionIDsToDelete:NULL];",
            "",
            "operation.modifySubscriptionsCompletionBlock =",
            "    ^(NSArray *subscriptions, NSArray *deleted, NSError *error) {",
            "    if (error) {",
            "        // Handle the error.",
            "    } else {",
            "        // Record that the system successfully creates the subscription",
            "        // to prevent unnecessary trips to the server in later launches.",
            "        [[NSUserDefaults standardUserDefaults]",
            "         setBool:YES forKey:@\"didCreateQuerySubscription\"];",
            "    }",
            "};",
            "        ",
            "// Set an appropriate QoS and add the operation to the private",
            "// database's operation queue to execute it.",
            "operation.qualityOfService = NSQualityOfServiceUtility;",
            "[CKContainer.defaultContainer.privateCloudDatabase addOperation:operation];"
          ],
          "syntax": "swift",
          "metadata": {
            "anchor": "3735561",
            "title": "Listing 1"
          }
        },
        {
          "type": "paragraph",
          "inlineContent": []
        },
        {
          "type": "paragraph",
          "inlineContent": []
        }
      ]
    }
  ],
  "legalNotices": {
    "copyright": "Copyright &copy; 2021 Apple Inc. All rights reserved.",
    "termsOfUse": "https://www.apple.com/legal/internet-services/terms/site.html",
    "privacyPolicy": "https://www.apple.com/privacy/privacy-policy"
  }
}