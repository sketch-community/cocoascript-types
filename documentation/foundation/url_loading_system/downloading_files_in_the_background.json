{
  "abstract": [
    {
      "type": "text",
      "text": "Create tasks that download files while your app is inactive."
    }
  ],
  "documentVersion": 0,
  "hierarchy": {
    "paths": [
      [
        "doc://com.apple.documentation/documentation/technologies",
        "doc://com.apple.documentation/documentation/foundation",
        "doc://com.apple.documentation/documentation/foundation/url_loading_system"
      ]
    ]
  },
  "identifier": {
    "url": "doc://com.apple.documentation/documentation/foundation/url_loading_system/downloading_files_in_the_background",
    "interfaceLanguage": "occ"
  },
  "legacy_identifier": 2919403,
  "kind": "article",
  "metadata": {
    "title": "Downloading Files in the Background",
    "role": "article",
    "roleHeading": "Article",
    "modules": [
      {
        "name": "Foundation"
      }
    ]
  },
  "schemaVersion": {
    "major": 0,
    "minor": 1,
    "patch": 0
  },
  "sections": [],
  "variants": [
    {
      "traits": [
        {
          "interfaceLanguage": "occ"
        }
      ],
      "paths": [
        "documentation/foundation/url_loading_system/downloading_files_in_the_background"
      ]
    },
    {
      "traits": [
        {
          "interfaceLanguage": "swift"
        }
      ],
      "paths": [
        "documentation/foundation/url_loading_system/downloading_files_in_the_background"
      ]
    }
  ],
  "references": {
    "doc://com.apple.documentation/documentation/foundation": {
      "title": "Foundation",
      "identifier": "doc://com.apple.documentation/documentation/foundation",
      "url": "/documentation/foundation",
      "type": "topic",
      "kind": "symbol",
      "role": "collection"
    },
    "doc://com.apple.documentation/documentation/foundation/url_loading_system": {
      "title": "URL Loading System",
      "identifier": "doc://com.apple.documentation/documentation/foundation/url_loading_system",
      "url": "/documentation/foundation/url_loading_system",
      "type": "topic",
      "kind": "article",
      "role": "collectionGroup"
    },
    "doc://com.apple.documentation/documentation/foundation/nsurlsession": {
      "title": "NSURLSession",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsession",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/foundation/nsurlsession"
    },
    "doc://com.apple.documentation/documentation/foundation/nsurlsessionconfiguration": {
      "title": "NSURLSessionConfiguration",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsessionconfiguration",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/foundation/nsurlsessionconfiguration"
    },
    "doc://com.apple.documentation/documentation/foundation/nsurlsessionconfiguration/1407496-backgroundsessionconfigurationwi": {
      "title": "backgroundSessionConfigurationWithIdentifier:",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsessionconfiguration/1407496-backgroundsessionconfigurationwi",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/foundation/nsurlsessionconfiguration/1407496-backgroundsessionconfigurationwi",
      "fragments": [
        {
          "kind": "text",
          "text": "+ "
        },
        {
          "kind": "identifier",
          "text": "backgroundSessionConfigurationWithIdentifier:"
        }
      ]
    },
    "doc://com.apple.documentation/documentation/foundation/nsurlsessionconfiguration/1617174-sessionsendslaunchevents": {
      "title": "sessionSendsLaunchEvents",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsessionconfiguration/1617174-sessionsendslaunchevents",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/foundation/nsurlsessionconfiguration/1617174-sessionsendslaunchevents"
    },
    "doc://com.apple.documentation/documentation/foundation/nsurlsessionconfiguration/1411552-discretionary": {
      "title": "discretionary",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsessionconfiguration/1411552-discretionary",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/foundation/nsurlsessionconfiguration/1411552-discretionary"
    },
    "doc://com.apple.documentation/documentation/foundation/url_loading_system/downloading_files_in_the_background#2920777": {
      "title": "Listing 1",
      "type": "section",
      "identifier": "doc://com.apple.documentation/documentation/foundation/url_loading_system/downloading_files_in_the_background#2920777",
      "kind": "article",
      "role": "codeListing",
      "url": "/documentation/foundation/url_loading_system/downloading_files_in_the_background#2920777",
      "abstract": [
        {
          "type": "text",
          "text": "Creating a background URL session"
        }
      ]
    },
    "link-2936294": {
      "title": "Profiles and Logs",
      "type": "topic",
      "identifier": "link-2936294",
      "kind": "article",
      "role": "link",
      "url": "https://developer.apple.com/bug-reporting/profiles-and-logs/"
    },
    "doc://com.apple.documentation/documentation/foundation/nsurlsession/1411482-downloadtaskwithurl": {
      "title": "downloadTaskWithURL:",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsession/1411482-downloadtaskwithurl",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/foundation/nsurlsession/1411482-downloadtaskwithurl",
      "fragments": [
        {
          "kind": "text",
          "text": "- "
        },
        {
          "kind": "identifier",
          "text": "downloadTaskWithURL:"
        }
      ]
    },
    "doc://com.apple.documentation/documentation/foundation/nsurlsession/1411481-downloadtaskwithrequest": {
      "title": "downloadTaskWithRequest:",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsession/1411481-downloadtaskwithrequest",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/foundation/nsurlsession/1411481-downloadtaskwithrequest",
      "fragments": [
        {
          "kind": "text",
          "text": "- "
        },
        {
          "kind": "identifier",
          "text": "downloadTaskWithRequest:"
        }
      ]
    },
    "doc://com.apple.documentation/documentation/foundation/urlrequest": {
      "title": "URLRequest",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/foundation/urlrequest",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/foundation/urlrequest"
    },
    "doc://com.apple.documentation/documentation/foundation/nsurlsessiontask/2873413-earliestbegindate": {
      "title": "earliestBeginDate",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsessiontask/2873413-earliestbegindate",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/foundation/nsurlsessiontask/2873413-earliestbegindate"
    },
    "doc://com.apple.documentation/documentation/foundation/nsurlsessiontask/2873401-countofbytesclientexpectstosend": {
      "title": "countOfBytesClientExpectsToSend",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsessiontask/2873401-countofbytesclientexpectstosend",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/foundation/nsurlsessiontask/2873401-countofbytesclientexpectstosend"
    },
    "doc://com.apple.documentation/documentation/foundation/nsurlsessiontask/2873414-countofbytesclientexpectstorecei": {
      "title": "countOfBytesClientExpectsToReceive",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsessiontask/2873414-countofbytesclientexpectstorecei",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/foundation/nsurlsessiontask/2873414-countofbytesclientexpectstorecei"
    },
    "doc://com.apple.documentation/documentation/foundation/nsurlsessiontask/1411121-resume": {
      "title": "resume",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsessiontask/1411121-resume",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/foundation/nsurlsessiontask/1411121-resume",
      "fragments": [
        {
          "kind": "text",
          "text": "- "
        },
        {
          "kind": "identifier",
          "text": "resume"
        }
      ]
    },
    "doc://com.apple.documentation/documentation/foundation/url_loading_system/downloading_files_in_the_background#2920776": {
      "title": "Listing 2",
      "type": "section",
      "identifier": "doc://com.apple.documentation/documentation/foundation/url_loading_system/downloading_files_in_the_background#2920776",
      "kind": "article",
      "role": "codeListing",
      "url": "/documentation/foundation/url_loading_system/downloading_files_in_the_background#2920776",
      "abstract": [
        {
          "type": "text",
          "text": "Creating a download task from a URL session"
        }
      ]
    },
    "doc://com.apple.documentation/documentation/uikit/app_and_environment/managing_your_app_s_life_cycle": {
      "title": "Managing Your App's Life Cycle",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/uikit/app_and_environment/managing_your_app_s_life_cycle",
      "kind": "article",
      "role": "article",
      "url": "/documentation/uikit/app_and_environment/managing_your_app_s_life_cycle"
    },
    "doc://com.apple.documentation/documentation/uikit/uiapplicationdelegate": {
      "title": "UIApplicationDelegate",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/uikit/uiapplicationdelegate",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/uikit/uiapplicationdelegate"
    },
    "doc://com.apple.documentation/documentation/uikit/uiapplicationdelegate/1622941-application": {
      "title": "application:handleEventsForBackgroundURLSession:completionHandler:",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/uikit/uiapplicationdelegate/1622941-application",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/uikit/uiapplicationdelegate/1622941-application",
      "fragments": [
        {
          "kind": "text",
          "text": "- "
        },
        {
          "kind": "identifier",
          "text": "application:handleEventsForBackgroundURLSession:completionHandler:"
        }
      ]
    },
    "doc://com.apple.documentation/documentation/foundation/nsurlsessiondownloaddelegate": {
      "title": "NSURLSessionDownloadDelegate",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsessiondownloaddelegate",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/foundation/nsurlsessiondownloaddelegate"
    },
    "doc://com.apple.documentation/documentation/foundation/url_loading_system/downloading_files_in_the_background#2936325": {
      "title": "Listing 3",
      "type": "section",
      "identifier": "doc://com.apple.documentation/documentation/foundation/url_loading_system/downloading_files_in_the_background#2936325",
      "kind": "article",
      "role": "codeListing",
      "url": "/documentation/foundation/url_loading_system/downloading_files_in_the_background#2936325",
      "abstract": [
        {
          "type": "text",
          "text": "Storing the background download completion handler sent to the application delegate"
        }
      ]
    },
    "doc://com.apple.documentation/documentation/foundation/nsurlsessiondelegate/1617185-urlsessiondidfinisheventsforback": {
      "title": "URLSessionDidFinishEventsForBackgroundURLSession:",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsessiondelegate/1617185-urlsessiondidfinisheventsforback",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/foundation/nsurlsessiondelegate/1617185-urlsessiondidfinisheventsforback",
      "fragments": [
        {
          "kind": "text",
          "text": "- "
        },
        {
          "kind": "identifier",
          "text": "URLSessionDidFinishEventsForBackgroundURLSession:"
        }
      ]
    },
    "doc://com.apple.documentation/documentation/foundation/nsurlsessiondelegate": {
      "title": "NSURLSessionDelegate",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsessiondelegate",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/foundation/nsurlsessiondelegate"
    },
    "doc://com.apple.documentation/documentation/foundation/url_loading_system/downloading_files_in_the_background#2928519": {
      "title": "Listing 4",
      "type": "section",
      "identifier": "doc://com.apple.documentation/documentation/foundation/url_loading_system/downloading_files_in_the_background#2928519",
      "kind": "article",
      "role": "codeListing",
      "url": "/documentation/foundation/url_loading_system/downloading_files_in_the_background#2928519",
      "abstract": [
        {
          "type": "text",
          "text": "Executing the background URL session completion handler on the main queue"
        }
      ]
    },
    "doc://com.apple.documentation/documentation/foundation/nsurlsessiondownloaddelegate/1411575-urlsession": {
      "title": "URLSession:downloadTask:didFinishDownloadingToURL:",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsessiondownloaddelegate/1411575-urlsession",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/foundation/nsurlsessiondownloaddelegate/1411575-urlsession",
      "fragments": [
        {
          "kind": "text",
          "text": "- "
        },
        {
          "kind": "identifier",
          "text": "URLSession:downloadTask:didFinishDownloadingToURL:"
        }
      ]
    },
    "doc://com.apple.documentation/documentation/foundation/url_loading_system/downloading_files_from_websites": {
      "title": "Downloading Files from Websites",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/foundation/url_loading_system/downloading_files_from_websites",
      "kind": "article",
      "role": "article",
      "url": "/documentation/foundation/url_loading_system/downloading_files_from_websites",
      "abstract": [
        {
          "type": "text",
          "text": "Download files directly to the filesystem."
        }
      ]
    },
    "doc://com.apple.documentation/documentation/foundation/url_loading_system/downloading_files_in_the_background#2928518": {
      "title": "Handle App Suspension",
      "type": "section",
      "identifier": "doc://com.apple.documentation/documentation/foundation/url_loading_system/downloading_files_in_the_background#2928518",
      "kind": "article",
      "role": "subsection",
      "url": "/documentation/foundation/url_loading_system/downloading_files_in_the_background#2928518"
    },
    "doc://com.apple.documentation/documentation/objectivec/yes": {
      "title": "YES",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/objectivec/yes",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/objectivec/yes"
    },
    "doc://com.apple.documentation/documentation/foundation/nsurlsessiontaskdelegate/1411626-urlsession": {
      "title": "URLSession:task:willPerformHTTPRedirection:newRequest:completionHandler:",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsessiontaskdelegate/1411626-urlsession",
      "kind": "symbol",
      "role": "symbol",
      "url": "/documentation/foundation/nsurlsessiontaskdelegate/1411626-urlsession",
      "fragments": [
        {
          "kind": "text",
          "text": "- "
        },
        {
          "kind": "identifier",
          "text": "URLSession:task:willPerformHTTPRedirection:newRequest:completionHandler:"
        }
      ]
    },
    "doc://com.apple.documentation/documentation/foundation/url_loading_system/pausing_and_resuming_downloads": {
      "title": "Pausing and Resuming Downloads",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/foundation/url_loading_system/pausing_and_resuming_downloads",
      "kind": "article",
      "role": "article",
      "url": "/documentation/foundation/url_loading_system/pausing_and_resuming_downloads",
      "abstract": [
        {
          "type": "text",
          "text": "Allow the user to resume a download without starting over."
        }
      ]
    },
    "doc://com.apple.documentation/documentation/foundation/url_loading_system/downloading_files_in_the_background": {
      "title": "Downloading Files in the Background",
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/foundation/url_loading_system/downloading_files_in_the_background",
      "kind": "article",
      "role": "article",
      "url": "/documentation/foundation/url_loading_system/downloading_files_in_the_background",
      "abstract": [
        {
          "type": "text",
          "text": "Create tasks that download files while your app is inactive."
        }
      ]
    },
    "doc://com.apple.documentation/documentation/technologies": {
      "type": "topic",
      "identifier": "doc://com.apple.documentation/documentation/technologies",
      "url": "/documentation/technologies",
      "kind": "technologies",
      "title": "Technologies"
    }
  },
  "seeAlsoSections": [
    {
      "identifiers": [
        "doc://com.apple.documentation/documentation/foundation/url_loading_system/downloading_files_from_websites",
        "doc://com.apple.documentation/documentation/foundation/url_loading_system/pausing_and_resuming_downloads"
      ],
      "title": "Downloading",
      "generated": true
    }
  ],
  "primaryContentSections": [
    {
      "kind": "content",
      "content": [
        {
          "anchor": "overview",
          "level": 2,
          "text": "Overview",
          "type": "heading"
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "For long-running and nonurgent transfers, you can create tasks that run in the background. These tasks continue to run even when your app is suspended, allowing your app to access the downloaded file when the app is resumed. "
            }
          ]
        },
        {
          "type": "aside",
          "content": [
            {
              "type": "paragraph",
              "inlineContent": [
                {
                  "type": "text",
                  "text": "You don’t have to do all background network activity with background sessions as described in this article. Apps that declare appropriate background modes can use default URL sessions and data tasks, just as if they were in the foreground."
                }
              ]
            }
          ],
          "style": "note",
          "name": "Note"
        },
        {
          "level": 3,
          "type": "heading",
          "text": "Configure the Background Session",
          "anchor": "2920773"
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "To perform a background download, configure a "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsession"
            },
            {
              "type": "text",
              "text": " for background operation. "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/foundation/url_loading_system/downloading_files_in_the_background#2920777"
            },
            {
              "type": "text",
              "text": " demonstrates this process. "
            }
          ]
        },
        {
          "type": "orderedList",
          "items": [
            {
              "content": [
                {
                  "type": "paragraph",
                  "inlineContent": [
                    {
                      "type": "text",
                      "text": "Create a background "
                    },
                    {
                      "type": "reference",
                      "isActive": true,
                      "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsessionconfiguration"
                    },
                    {
                      "type": "text",
                      "text": " object with the class method "
                    },
                    {
                      "type": "reference",
                      "isActive": true,
                      "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsessionconfiguration/1407496-backgroundsessionconfigurationwi"
                    },
                    {
                      "type": "text",
                      "text": " of "
                    },
                    {
                      "type": "reference",
                      "isActive": false,
                      "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsession"
                    },
                    {
                      "type": "text",
                      "text": ", providing a session identifier that is unique within your app. Because most apps need only a few background sessions (usually one), you can use a fixed string for the identifier, rather than a dynamically generated identifier. The identifier doesn’t need to be unique globally. "
                    }
                  ]
                }
              ]
            },
            {
              "content": [
                {
                  "type": "paragraph",
                  "inlineContent": [
                    {
                      "type": "text",
                      "text": "To have the system to wake up your app when a task completes and the app is in the background, make sure the "
                    },
                    {
                      "type": "reference",
                      "isActive": true,
                      "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsessionconfiguration/1617174-sessionsendslaunchevents"
                    },
                    {
                      "type": "text",
                      "text": " property is set to "
                    },
                    {
                      "type": "codeVoice",
                      "code": "true"
                    },
                    {
                      "type": "text",
                      "text": " (the default)."
                    }
                  ]
                }
              ]
            },
            {
              "content": [
                {
                  "type": "paragraph",
                  "inlineContent": [
                    {
                      "type": "text",
                      "text": "For time-insensitive tasks, enable the "
                    },
                    {
                      "type": "reference",
                      "isActive": true,
                      "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsessionconfiguration/1411552-discretionary"
                    },
                    {
                      "type": "text",
                      "text": " property, so the system can wait for optimal conditions to perform the transfer, such as when the device is plugged in or connected to Wi-Fi."
                    }
                  ]
                }
              ]
            },
            {
              "content": [
                {
                  "type": "paragraph",
                  "inlineContent": [
                    {
                      "type": "text",
                      "text": "Use the "
                    },
                    {
                      "type": "reference",
                      "isActive": false,
                      "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsessionconfiguration"
                    },
                    {
                      "type": "text",
                      "text": " instance to create a "
                    },
                    {
                      "type": "reference",
                      "isActive": false,
                      "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsession"
                    },
                    {
                      "type": "text",
                      "text": " instance. Provide a delegate, to receive events from the background transfer. "
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "paragraph",
          "inlineContent": []
        },
        {
          "type": "codeListing",
          "code": [
            "private lazy var urlSession: URLSession = {",
            "    let config = URLSessionConfiguration.background(withIdentifier: \"MySession\")",
            "    config.isDiscretionary = true",
            "    config.sessionSendsLaunchEvents = true",
            "    return URLSession(configuration: config, delegate: self, delegateQueue: nil)",
            "}()"
          ],
          "syntax": "swift",
          "metadata": {
            "anchor": "2920777",
            "title": "Listing 1",
            "abstract": [
              {
                "type": "text",
                "text": "Creating a background URL session"
              }
            ]
          }
        },
        {
          "type": "paragraph",
          "inlineContent": []
        },
        {
          "type": "aside",
          "content": [
            {
              "type": "paragraph",
              "inlineContent": [
                {
                  "type": "text",
                  "text": "For more visibility into how the system is scheduling and performing your background tasks, download and install the Background Networking Profile onto your iOS device from the Bug Reporting "
                },
                {
                  "type": "link",
                  "title": "Profiles and Logs",
                  "destination": "https://developer.apple.com/bug-reporting/profiles-and-logs/"
                },
                {
                  "type": "text",
                  "text": " page."
                }
              ]
            }
          ],
          "style": "note",
          "name": "Note"
        },
        {
          "type": "paragraph",
          "inlineContent": []
        },
        {
          "level": 3,
          "type": "heading",
          "text": "Create and Schedule the Download Task",
          "anchor": "2920774"
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "You create download tasks from the session with either the "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsession/1411482-downloadtaskwithurl"
            },
            {
              "type": "text",
              "text": " method that takes a URL, or the "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsession/1411481-downloadtaskwithrequest"
            },
            {
              "type": "text",
              "text": " method that takes a "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/foundation/urlrequest"
            },
            {
              "type": "text",
              "text": " instance.  You set properties on this method to help the system optimize its behavior. "
            }
          ]
        },
        {
          "type": "orderedList",
          "items": [
            {
              "content": [
                {
                  "type": "paragraph",
                  "inlineContent": [
                    {
                      "type": "text",
                      "text": "As shown in "
                    },
                    {
                      "type": "reference",
                      "isActive": true,
                      "identifier": "doc://com.apple.documentation/documentation/foundation/url_loading_system/downloading_files_in_the_background#2920776"
                    },
                    {
                      "type": "text",
                      "text": ", create a download task with "
                    },
                    {
                      "type": "reference",
                      "isActive": false,
                      "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsession/1411482-downloadtaskwithurl"
                    },
                    {
                      "type": "text",
                      "text": "."
                    }
                  ]
                }
              ]
            },
            {
              "content": [
                {
                  "type": "paragraph",
                  "inlineContent": [
                    {
                      "type": "text",
                      "text": "Optionally, set the "
                    },
                    {
                      "type": "reference",
                      "isActive": true,
                      "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsessiontask/2873413-earliestbegindate"
                    },
                    {
                      "type": "text",
                      "text": " property to schedule the download to begin at a particular point in the future. The download isn’t guaranteed to begin at precisely this time, but it won’t start sooner. "
                    }
                  ]
                }
              ]
            },
            {
              "content": [
                {
                  "type": "paragraph",
                  "inlineContent": [
                    {
                      "type": "text",
                      "text": "To help the system schedule network activity efficiently, set the properties "
                    },
                    {
                      "type": "reference",
                      "isActive": true,
                      "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsessiontask/2873401-countofbytesclientexpectstosend"
                    },
                    {
                      "type": "text",
                      "text": " and "
                    },
                    {
                      "type": "reference",
                      "isActive": true,
                      "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsessiontask/2873414-countofbytesclientexpectstorecei"
                    },
                    {
                      "type": "text",
                      "text": ". These values are best-guess upper bounds on the expected byte count, and should account for headers as well as body data."
                    }
                  ]
                }
              ]
            },
            {
              "content": [
                {
                  "type": "paragraph",
                  "inlineContent": [
                    {
                      "type": "text",
                      "text": "To start the task, call "
                    },
                    {
                      "type": "reference",
                      "isActive": true,
                      "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsessiontask/1411121-resume"
                    },
                    {
                      "type": "text",
                      "text": "."
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "In "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/foundation/url_loading_system/downloading_files_in_the_background#2920776"
            },
            {
              "type": "text",
              "text": ", the task is set to begin at least one hour in the future and is configured to send around 200 bytes of data and receive around 500 KB."
            }
          ]
        },
        {
          "type": "codeListing",
          "code": [
            "let backgroundTask = urlSession.downloadTask(with: url)",
            "backgroundTask.earliestBeginDate = Date().addingTimeInterval(60 * 60)",
            "backgroundTask.countOfBytesClientExpectsToSend = 200",
            "backgroundTask.countOfBytesClientExpectsToReceive = 500 * 1024",
            "backgroundTask.resume()"
          ],
          "syntax": "swift",
          "metadata": {
            "anchor": "2920776",
            "title": "Listing 2",
            "abstract": [
              {
                "type": "text",
                "text": "Creating a download task from a URL session"
              }
            ]
          }
        },
        {
          "level": 3,
          "type": "heading",
          "text": "Handle App Suspension",
          "anchor": "2928518"
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "Different app states affect how your app interacts with the background download. In iOS, your app could be in the foreground, suspended, or even terminated by the system. See "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/uikit/app_and_environment/managing_your_app_s_life_cycle"
            },
            {
              "type": "text",
              "text": " for more information about these states."
            }
          ]
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "If your app is in the background, the system may suspend your app while the download is performed in another process. In this case, when the download finishes, the system resumes the app and calls the "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/uikit/uiapplicationdelegate"
            },
            {
              "type": "text",
              "text": " method "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/uikit/uiapplicationdelegate/1622941-application"
            },
            {
              "type": "text",
              "text": ". This method receives the session identifier you created in "
            },
            {
              "type": "reference",
              "isActive": false,
              "identifier": "doc://com.apple.documentation/documentation/foundation/url_loading_system/downloading_files_in_the_background#2920777"
            },
            {
              "type": "text",
              "text": " as its second parameter."
            }
          ]
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "This delegate method also receives a completion handler as its final parameter. Immediately store this handler wherever it makes sense for your app, perhaps as a property of your app delegate, or of your class that implements "
            },
            {
              "type": "reference",
              "isActive": false,
              "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsessiondownloaddelegate"
            },
            {
              "type": "text",
              "text": ". In "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/foundation/url_loading_system/downloading_files_in_the_background#2936325"
            },
            {
              "type": "text",
              "text": ", this completion handler is stored in an app delegate property called "
            },
            {
              "type": "codeVoice",
              "code": "backgroundCompletionHandler"
            },
            {
              "type": "text",
              "text": "."
            }
          ]
        },
        {
          "type": "codeListing",
          "code": [
            "func application(_ application: UIApplication,",
            "                 handleEventsForBackgroundURLSession identifier: String,",
            "                 completionHandler: @escaping () -> Void) {",
            "        backgroundCompletionHandler = completionHandler",
            "}"
          ],
          "syntax": "swift",
          "metadata": {
            "anchor": "2936325",
            "title": "Listing 3",
            "abstract": [
              {
                "type": "text",
                "text": "Storing the background download completion handler sent to the application delegate"
              }
            ]
          }
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "When all events have been delivered,  the system calls the "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsessiondelegate/1617185-urlsessiondidfinisheventsforback"
            },
            {
              "type": "text",
              "text": " method of "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsessiondelegate"
            },
            {
              "type": "text",
              "text": ". At this point, fetch  the "
            },
            {
              "type": "codeVoice",
              "code": "backgroundCompletionHandler"
            },
            {
              "type": "text",
              "text": " stored by the app delegate in "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/foundation/url_loading_system/downloading_files_in_the_background#2936325"
            },
            {
              "type": "text",
              "text": " and execute it. "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/foundation/url_loading_system/downloading_files_in_the_background#2928519"
            },
            {
              "type": "text",
              "text": " shows this process."
            }
          ]
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "Note that because "
            },
            {
              "type": "reference",
              "isActive": false,
              "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsessiondelegate/1617185-urlsessiondidfinisheventsforback"
            },
            {
              "type": "text",
              "text": " may be called on a secondary queue, it needs to explicitly execute the handler (which was received from a UIKit method) on the main queue."
            }
          ]
        },
        {
          "type": "codeListing",
          "code": [
            "func urlSessionDidFinishEvents(forBackgroundURLSession session: URLSession) {",
            "    DispatchQueue.main.async {",
            "        guard let appDelegate = UIApplication.shared.delegate as? AppDelegate,",
            "            let backgroundCompletionHandler =",
            "            appDelegate.backgroundCompletionHandler else {",
            "                return",
            "        }",
            "        backgroundCompletionHandler()",
            "    }",
            "}"
          ],
          "syntax": "swift",
          "metadata": {
            "anchor": "2928519",
            "title": "Listing 4",
            "abstract": [
              {
                "type": "text",
                "text": "Executing the background URL session completion handler on the main queue"
              }
            ]
          }
        },
        {
          "type": "paragraph",
          "inlineContent": []
        },
        {
          "level": 3,
          "type": "heading",
          "text": "Access the File, or Move It to a Permanent Location",
          "anchor": "3087615"
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "Once your resumed app calls the completion handler, the download task finishes its work and calls the delegate’s "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsessiondownloaddelegate/1411575-urlsession"
            },
            {
              "type": "text",
              "text": " method. At this point, the file is fully downloaded, and will be available until your delegate method returns. If you only need to read it once, you can access the file immediately in its temporary location. If you want to preserve the file, move it to a permanent location like the "
            },
            {
              "type": "codeVoice",
              "code": "Documents"
            },
            {
              "type": "text",
              "text": " directory, as described in "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/foundation/url_loading_system/downloading_files_from_websites"
            },
            {
              "type": "text",
              "text": "."
            }
          ]
        },
        {
          "level": 3,
          "type": "heading",
          "text": "Recreate the Session If the App Was Terminated",
          "anchor": "2936566"
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "If the system terminated the app while it was suspended, the system relaunches the app in the background. As part of your launch time setup, recreate the background session (see "
            },
            {
              "type": "reference",
              "isActive": false,
              "identifier": "doc://com.apple.documentation/documentation/foundation/url_loading_system/downloading_files_in_the_background#2920777"
            },
            {
              "type": "text",
              "text": "), using the same session identifier as before, to allow the system to reassociate the background download task with your session. You do this so your background session is ready to go whether the app was launched by the user or by the system. Once the app relaunches, the series of events is the same as if the app had been suspended and resumed, as discussed earlier in "
            },
            {
              "type": "reference",
              "isActive": true,
              "identifier": "doc://com.apple.documentation/documentation/foundation/url_loading_system/downloading_files_in_the_background#2928518"
            },
            {
              "type": "text",
              "text": "."
            }
          ]
        },
        {
          "type": "aside",
          "content": [
            {
              "type": "paragraph",
              "inlineContent": [
                {
                  "type": "text",
                  "text": "In cases where the transfer is initiated while the app is in the background, the session configuration's "
                },
                {
                  "type": "reference",
                  "isActive": false,
                  "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsessionconfiguration/1411552-discretionary"
                },
                {
                  "type": "text",
                  "text": " property is treated as being "
                },
                {
                  "type": "reference",
                  "isActive": false,
                  "identifier": "doc://com.apple.documentation/documentation/objectivec/yes"
                },
                {
                  "type": "text",
                  "text": "."
                }
              ]
            }
          ],
          "style": "note",
          "name": "Note"
        },
        {
          "level": 3,
          "type": "heading",
          "text": "Comply with Background Transfer Limitations",
          "anchor": "2920790"
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "With background sessions, the actual transfer is performed by a process that is separate from your app’s process. Because restarting your app’s process is fairly expensive, a few features are unavailable, resulting in the following limitations:"
            }
          ]
        },
        {
          "type": "unorderedList",
          "items": [
            {
              "content": [
                {
                  "type": "paragraph",
                  "inlineContent": [
                    {
                      "type": "text",
                      "text": "The session "
                    },
                    {
                      "type": "emphasis",
                      "inlineContent": [
                        {
                          "type": "text",
                          "text": "must"
                        }
                      ]
                    },
                    {
                      "type": "text",
                      "text": " provide a delegate for event delivery. (For uploads and downloads, the delegates behave the same as for in-process transfers.)"
                    }
                  ]
                }
              ]
            },
            {
              "content": [
                {
                  "type": "paragraph",
                  "inlineContent": [
                    {
                      "type": "text",
                      "text": "Only HTTP and HTTPS protocols are supported (no custom protocols)."
                    }
                  ]
                }
              ]
            },
            {
              "content": [
                {
                  "type": "paragraph",
                  "inlineContent": [
                    {
                      "type": "text",
                      "text": "Redirects are always followed. As a result, even if you have implemented "
                    },
                    {
                      "type": "reference",
                      "isActive": true,
                      "identifier": "doc://com.apple.documentation/documentation/foundation/nsurlsessiontaskdelegate/1411626-urlsession"
                    },
                    {
                      "type": "text",
                      "text": ", it is "
                    },
                    {
                      "type": "emphasis",
                      "inlineContent": [
                        {
                          "type": "text",
                          "text": "not"
                        }
                      ]
                    },
                    {
                      "type": "text",
                      "text": " called."
                    }
                  ]
                }
              ]
            },
            {
              "content": [
                {
                  "type": "paragraph",
                  "inlineContent": [
                    {
                      "type": "text",
                      "text": "Only upload tasks from a file are supported (uploads from data instances or a stream fail after the app exits). "
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "paragraph",
          "inlineContent": []
        },
        {
          "level": 3,
          "type": "heading",
          "text": "Use Background Sessions Efficiently",
          "anchor": "3038438"
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "When the system resumes or relaunches your app, it uses a rate limiter to prevent abuse of background downloads. When your app starts a new download task while in the background, the task doesn't begin until the delay expires. The delay increases each time the system resumes or relaunches your app."
            }
          ]
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "As a result, if your app starts a single background download, gets resumed when the download completes, and then starts a new download, it will greatly increase the delay. Instead, use a small number of background sessions — ideally just one — and use these sessions to start many download tasks at once. This allows the system to perform multiple downloads at once, and resume your app when they have completed."
            }
          ]
        },
        {
          "type": "paragraph",
          "inlineContent": [
            {
              "type": "text",
              "text": "Keep in mind, though, that each task has its own overhead. If you find you need to launch thousands of download tasks, change your design to perform fewer, larger transfers."
            }
          ]
        },
        {
          "type": "aside",
          "content": [
            {
              "type": "paragraph",
              "inlineContent": [
                {
                  "type": "text",
                  "text": "The delay is reset to 0 whenever the user brings your app to the foreground. It also resets if the delay period elapses without the system resuming or relaunching your app."
                }
              ]
            }
          ],
          "style": "note",
          "name": "Note"
        },
        {
          "type": "paragraph",
          "inlineContent": []
        }
      ]
    }
  ],
  "legalNotices": {
    "copyright": "Copyright &copy; 2021 Apple Inc. All rights reserved.",
    "termsOfUse": "https://www.apple.com/legal/internet-services/terms/site.html",
    "privacyPolicy": "https://www.apple.com/privacy/privacy-policy"
  }
}